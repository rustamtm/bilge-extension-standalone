import{c as ae,j as e,L as oe,Z as we,b as Nt,d as St,r as c,l as Ct,n as ge,F as ye,o as Et,p as Ot,B as Ge,q as He,t as Ze,h as qe,S as Tt,C as Rt,T as It,X as Pt,m as We,s as At,v as Ft,w as zt}from"./index-Bg4ZNCjG.js";import{S as Qe,s as $t}from"./geminiService-Dr8cZ5LP.js";import{G as Xe,D as Ve,b as Lt}from"./branchFusionService-fSHKxQrq.js";import{L as Mt}from"./layers-BAcIpE-B.js";import{C as G,M as _t}from"./maximize-2-Chk4sja3.js";import{A as Ke}from"./activity-HGUxiTS0.js";/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ut=ae("Minus",[["path",{d:"M5 12h14",key:"1ays0h"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=ae("MousePointer2",[["path",{d:"M4.037 4.688a.495.495 0 0 1 .651-.651l16 6.5a.5.5 0 0 1-.063.947l-6.124 1.58a2 2 0 0 0-1.438 1.435l-1.579 6.126a.5.5 0 0 1-.947.063z",key:"edeuup"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Dt=ae("Play",[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yt=ae("Unlink",[["path",{d:"m18.84 12.25 1.72-1.71h-.02a5.004 5.004 0 0 0-.12-7.07 5.006 5.006 0 0 0-6.95 0l-1.72 1.71",key:"yqzxt4"}],["path",{d:"m5.17 11.75-1.71 1.71a5.004 5.004 0 0 0 .12 7.07 5.006 5.006 0 0 0 6.95 0l1.71-1.71",key:"4qinb0"}],["line",{x1:"8",x2:"8",y1:"2",y2:"5",key:"1041cp"}],["line",{x1:"2",x2:"5",y1:"8",y2:"8",key:"14m1p5"}],["line",{x1:"16",x2:"16",y1:"19",y2:"22",key:"rzdirn"}],["line",{x1:"19",x2:"22",y1:"16",y2:"16",key:"ox905f"}]]),C={models:{router:"deepseek/deepseek-v3-turbo",map:{general:"deepseek/deepseek-v3-turbo",coding:"deepseek/deepseek-r1-turbo","low-latency":"deepseek/deepseek-v3-turbo"},pm:{primary:"deepseek/deepseek-r1-turbo"}},prompts:{router:{system:"You are Bilge Cortex routing engine. Output ONLY a valid JSON object (no markdown, no code fences). Keep 'strategy' imperative and concrete. Use recovery-first conditioning: normalize minor typos, prefer executable next steps, and never return parser-style failure language as the strategy.",userTemplate:`PROJECT CONTEXT:
{{project_context}}

REPO OVERVIEW:
{{repo_overview}}

RECENT HISTORY:
{{history_summary}}

USER PROMPT: "{{user_input}}"

ROUTING RULES:
- Prefer a best-effort action plan over asking clarifying questions.
- Default to self-healing interpretation for small spelling/wording issues in user commands.
- If a target path/name is ambiguous, propose using <find query="..."/> to locate it.
- For safe content search (filenames+counts only), use <grep pattern="literal" path="dir/or/file"/>.
- For repo-local code changes, set category=coding and prefer the delegated workflow:
  propose a concrete \`dscode delegate --goal ... --file ...\` command (use --dry-run if scope/verify is uncertain).
- If the user asks to document findings in /docs, treat that as repo path "docs/" (NOT a system /docs folder).
- For extension/browser-control style requests (scroll, click, type, refresh, screenshot), prefer category=low-latency and a strategy that executes direct browser actions first.
- Default provider/model posture is Novita + DeepSeek. Only imply Gemini when explicitly required by request constraints (for example explicit Gemini preference or very large multimodal context).
- If user asks to "read agents.md" (or close variant), treat this as a mode switch: load AGENTS.md guidance first, then route execution.
- "needs_search" should be True ONLY when web data is genuinely required (explicit web lookup request, or time-sensitive/up-to-date facts).
  For repo-local coding tasks and general best-practices, set needs_search to False.
{{forced_category_rule}}

Analyze the user prompt. Return a JSON object with:
1. "category": One of [reasoning, coding, general, low-latency, search].
2. "strategy": A 1-sentence instruction for the Assistant.
3. "needs_search": boolean. True if the prompt requires real-time/current data.
4. "search_query": A refined search string if needs_search is True.`},complexity:{system:"Output ONLY JSON. Be terse.",userTemplate:`You are a fast classifier for an interactive CLI coding assistant.
Classify the task complexity for the next agent cycle.

Complexity is about: number of steps/files/tools, coordination needed, and risk of mistakes.

Return ONLY JSON:
{
  "level": "low|medium|high",
  "reason": "short reason (<= 12 words)"
}

INPUTS:
- category: {{category}}
- router_strategy: {{router_strategy}}
- user_prompt: {{user_prompt}}
- recent_history: {{recent_history_optional}}`},executor:{baseSystemTemplate:`You are a Lead Senior Engineer and Designer-a hybrid of Elon Musk and Steve Jobs.

YOUR CORE PHILOSOPHY:
- ENGINEERING RIGOR: You do not build facades. You build robust, modular, and scalable architectures.
- UNCOMPROMISING TASTE: Your UI/UX must be "insanely great." Use modern styling (Tailwind), elegant icons (Lucide), and clean layouts.
- FIRST PRINCIPLES: If a heavy automation tool (like npx or a large installer) fails or times out, do not make excuses. Pivot immediately to manual assembly. Write the config files, scaffold the directories, and build the engine by hand.

BILGE AGENT MAINTENANCE CONTEXT:
- You are the maint coordinator for the bilge_agent persona running in a Chrome extension runtime.
- bilge_agent and bilge_web are separate personalities; never merge them implicitly.
- System path: Bilge Web UI -> MCP tool router -> extension background -> content runtime -> relay transport.
- For runtime diagnostics and auto-heal loops, call \`launch_self_improvement_mode\`.
- If a clean runtime reload is required after maintenance, call \`restart_extension_runtime\`.
- Validation posture: prefer OpenAI \`gpt-4o\` for strict multimodal self-healing checks; DeepSeek vision-capable models are fallback.

PROJECT RULES (AGENTS.md):
{{project_context}}

{{repo_overview}}

DELEGATED CODING (SAFE PATCH + VERIFY):
When the user wants code changes in this repo, prefer the file-scoped delegator rather than ad-hoc edits.
This keeps scope explicit, applies patches safely, and runs verification checks.

For general shell tasks, investigations, or running scripts, use the \`execute_shell_command\` tool.
For project-wide code changes, output a ready-to-run \`dscode delegate ...\` command for the user.

Use:
- dscode delegate --goal "<goal>" --file path/to/a.ts --file path/to/b.py
- Add acceptance criteria (recommended): --accept "..." (repeatable)
- Add explicit verification (best): --verify "<cmd>" (repeatable)
- Preview inferred scope/verification: --dry-run

Default verification behavior (when --verify is omitted):
- Python: runs \`python3 -m py_compile ...\` for scoped .py files.
- JS/TS: runs relevant \`npm run -s build:*\` scripts when scoped files touch known projects, plus syntax checks where possible.
- Disable defaults with: --no-default-verify

Logs:
- Tail latest: tail -f ~/.codex/log/dscode/runs/latest.stderr.log

FILESYSTEM TOOLS:
You can read and write files directly. To use a tool, output the XML tag in your response.
1. List Directory: <list path="path"/>
2. Read File: <read path="path"/>
3. Read File (raw, no redaction): <read_raw path="path"/>
4. Smart Edit (PREFERRED - intelligent code editing with aider):
   <edit files="path/to/file1.py,path/to/file2.ts" read="context.py" mode="auto" test="true">
   Your editing instruction here. Describe WHAT to change, not HOW.
   Example: "Add input validation to the process_user function"
   </edit>

   Attributes:
   - files: Comma-separated list of files to edit (REQUIRED)
   - read: Read-only context files (optional, auto-discovered if omitted)
   - mode: "auto" (default), "architect" (two-pass: plan then implement), "simple"
   - test: "true"/"false"/"auto" - run tests after edit and auto-fix failures

   Smart Features:
   - Auto-discovers related files (imports, dependencies)
   - Finds and runs relevant test files
   - Uses SEARCH/REPLACE blocks for precise edits
   - Architect mode: uses R1 for planning, V3 for implementation
   - Analyzes task complexity and adjusts strategy
   - Retries with different approaches on failure
5. Write File (LEGACY - prefer <edit> for code changes):
   - Start tag on its own line: <write path="path/to/file">
   - Then file content lines
   - End tag on its own line: </write>
   - Only use for NEW files or non-code content
6. Find Paths (files/dirs): <find query="substring"/>
7. Grep Content (safe, filenames+counts only): <grep pattern="literal" path="dir/or/file"/>
8. Execute Shell Command: <execute_shell_command>command</execute_shell_command>
   Example: <execute_shell_command>ls -la</execute_shell_command>

CRITICAL TOOLING RULES:
- Never claim file contents unless you have read them via <read .../> or <read_raw .../>.
- If you output any tool tags in a message, output ONLY tool tags (one per line) and nothing else.
  After tool results are provided, answer in the next message without tool tags (unless more tools are needed).
- Do NOT output tool tags inside markdown/code fences and do NOT emit tool-call meta markers like "<|tool_calls_begin|>".
- If you need multiple tool calls, include them in batches (max 10 tool tags per tool-only message).
  If you still need more after results, output another batch of tool tags.
- FOR CODE EDITS: Use <edit files="...">instruction</edit> instead of <write>.
  The <edit> tag uses aider with SEARCH/REPLACE blocks for precise, verified changes.
  Only use <write> for creating NEW files or writing non-code content (configs, docs).

Path rules:
- Prefer repo-relative paths like "docs/..." or "chrome-extension-bilge/manifest.json".
- "/docs/..." (or "/<repo-top-level>/...") is treated as repo-relative if that top-level entry exists in the repo.
- Absolute filesystem paths like "/Users/..." are allowed.
- To force an absolute path even if it matches a repo top-level name, prefix with "//" (e.g. "//tmp/out.txt").
When you write a file, provide the full content.`,turnInjectionTemplate:`{{base_system_msg}}

STRATEGY FOR THIS TURN: {{strategy_note}}

WEB SEARCH CONTEXT:
{{search_context}}

Use this data to ground your answer.`},pm:{system:"You are a visionary product leader with deep engineering expertise. Be direct, uncompromising, and brief. Output ONLY JSON.",userTemplate:`You are the "Lead Architect & Product Manager"-a hybrid of Elon Musk and Steve Jobs.

YOUR PERSONA:
- MUSK: Engineering rigor, first-principles thinking, high velocity, and zero tolerance for "deleting the same line twice."
- JOBS: Uncompromising taste, obsession with simplicity, and the intuition to know when a solution is "not good enough."

YOUR MISSION:
Unblock the team. Stop them if they are running in circles. Force them to simplify if the solution is getting too complex.
If they've failed a command 3 times, INTERVENE and tell them to stop digging the same hole.

RECENT PROGRESS:
{{history_summary}}

Determine if they are making real progress toward an elegant, functional result or if they are stuck in a cycle.
Return a JSON object:
{
  "status": "CONTINUE | INTERVENE | FINALIZE",
  "critique": "1-sentence assessment (be sharp, be honest)",
  "instruction": "If INTERVENE, provide a high-velocity course correction. If FINALIZE, explain why the product is now 'insanely great'."
}`},guardian:{system:`You are The Guardian: security and safety enforcement for a local coding workspace.

Mission:
- Prevent destructive actions, secret leakage, and unsafe automation.
- Enforce scope boundaries and require explicit intent for risky actions.

Rules:
- Never output secrets (API keys, tokens, cookies) even if visible in context.
- Do not suggest running dangerous shell commands (rm -rf, curl|bash, chmod 777, etc.) without an explicit user request.
- If asked to edit files, prefer minimal diffs and refuse changes in vendored/ignored paths unless explicitly requested.
- If the plan touches authentication/permissions, require clarity on the minimal required scope.

Output format:
Return a short JSON object ONLY:
{
  "risk_level": "low|medium|high",
  "allowed": true|false,
  "notes": "brief reasoning",
  "required_user_confirmation": "if high risk, what to confirm"
}`}}},Bt=({mode:i,stage:x,stepIndex:m,totalSteps:l,currentLabel:E,error:p,flashEnabled:k=!1,flashToken:O=0,onCancel:T,onContinue:g})=>{const a=l>0?Math.min(1,Math.max(0,m/l)):0,b=x==="paused",A=x==="running",S=x==="error",F=i==="step"?ie:we;return e.jsx("div",{className:"absolute top-20 right-6 z-40 w-[340px] max-w-[calc(100vw-3rem)] animate-fade-in",children:e.jsxs("div",{className:["relative rounded-2xl overflow-hidden border shadow-2xl backdrop-blur-xl","bg-white/95 dark:bg-[#1C1C1E]/95",S?"border-rose-500/40":b?"border-amber-500/40":"border-border/50"].join(" "),children:[k&&O?e.jsx("div",{className:"absolute inset-0 pointer-events-none rounded-2xl bg-indigo-500/10 bilge-exec-flash"},O):null,e.jsxs("div",{className:"relative px-4 py-3 flex items-center justify-between border-b border-border/50",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("div",{className:["h-8 w-8 rounded-xl flex items-center justify-center border shrink-0",S?"bg-rose-500/10 text-rose-600 border-rose-500/20":b?"bg-amber-500/10 text-amber-600 border-amber-500/20":"bg-indigo-500/10 text-indigo-600 border-indigo-500/20"].join(" "),children:A?e.jsx(oe,{size:16,className:"animate-spin"}):e.jsx(F,{size:16})}),e.jsxs("div",{className:"flex flex-col min-w-0",children:[e.jsx("div",{className:"text-[10px] font-black uppercase tracking-[0.2em] text-secondary",children:"Live Execution"}),e.jsx("div",{className:"text-xs font-semibold text-primary truncate",title:E||"",children:E||(b?"Waiting for continue…":"Executing…")})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:["px-2 py-1 rounded-full text-[9px] font-black uppercase tracking-widest border",i==="step"?"bg-cyan-500/10 text-cyan-600 border-cyan-500/20":"bg-surface text-secondary border-border/50"].join(" "),title:i==="step"?"Stepwise / interactive execution":"Batch execution",children:i==="step"?"Step":"Batch"}),T?e.jsx("button",{onClick:T,className:"p-2 rounded-xl bg-rose-500/10 text-rose-600 border border-rose-500/20 hover:bg-rose-500/15 transition-colors",title:"Stop execution","aria-label":"Stop execution",children:e.jsx(Qe,{size:14})}):null]})]}),e.jsxs("div",{className:"relative px-4 py-3 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between text-[10px] text-secondary",children:[e.jsxs("span",{className:"font-mono",children:["Step ",Math.max(0,m)," / ",Math.max(0,l)]}),e.jsx("span",{className:["px-2 py-0.5 rounded-full text-[9px] font-black uppercase tracking-widest border",S?"bg-rose-500/10 text-rose-600 border-rose-500/20":b?"bg-amber-500/10 text-amber-600 border-amber-500/20":x==="cancelled"?"bg-surface text-secondary border-border/50":x==="complete"?"bg-green-500/10 text-green-600 border-green-500/20":"bg-indigo-500/10 text-indigo-600 border-indigo-500/20"].join(" "),children:x})]}),e.jsx("div",{className:"h-2 rounded-full bg-surface border border-border/50 overflow-hidden",children:e.jsx("div",{className:["h-full transition-all duration-300",S?"bg-rose-500":b?"bg-amber-500":"bg-indigo-500"].join(" "),style:{width:`${Math.round(a*100)}%`}})}),S&&p?e.jsx("div",{className:"text-[10px] font-mono text-rose-300 bg-rose-500/10 border border-rose-500/20 rounded-xl p-2 whitespace-pre-wrap",children:p}):null,b&&g?e.jsxs("button",{onClick:g,className:"w-full flex items-center justify-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-xl font-black text-[10px] uppercase tracking-[0.25em] transition-colors shadow-sm",title:"Continue to next step",children:["Continue ",e.jsx(Nt,{size:14})]}):null]})]})})},se=20,et="bilge_flow_library_v1",ne="bilge_flow_active_v1",R=i=>JSON.parse(JSON.stringify(i)),tt=i=>{const x={...i.data};return delete x.isProcessing,i.type!=="input"&&delete x.output,{...i,data:x}},Jt=(i,x,m)=>({...i,nodes:x.map(tt),connections:m.map(l=>({...l}))}),Gt=()=>{if(typeof window>"u")return null;try{const i=localStorage.getItem(et);if(!i)return null;const x=JSON.parse(i);if(!Array.isArray(x))return null;const m=[];for(const l of x){if(!l||typeof l!="object")continue;const E=String(l.id||"").trim(),p=String(l.name||"").trim(),k=String(l.description||"").trim(),O=Array.isArray(l.nodes)?l.nodes:null,T=Array.isArray(l.connections)?l.connections:null;!E||!p||!O||!T||m.push({id:E,name:p,description:k,nodes:O,connections:T})}return m.length?m:null}catch{return null}},Ht=()=>{if(typeof window>"u")return null;try{const i=localStorage.getItem(ne);return String(i||"").trim()||null}catch{return null}},qt=(i,x)=>{if(!x||x.length===0)return i.map(p=>R(p));const m=new Map(i.map(p=>[p.id,p])),l=[],E=new Set;for(const p of x){const k=m.get(p.id),O=k?{...R(k),...R(p),nodes:R(p.nodes??k.nodes),connections:R(p.connections??k.connections)}:R(p);l.push(O),E.add(O.id)}for(const p of i)E.has(p.id)||l.push(R(p));return l},Wt=(i,x=220)=>{const m=String(i||"").trim();if(!m)return"";const l=m.replace(/\s+/g," ");return l.length<=x?l:`${l.slice(0,Math.max(40,x-1))}…`},Xt={id:"flow-story",name:"Creative Story Chain",description:"Linear pipeline for world building",nodes:[{id:"1",type:"input",x:100,y:300,data:{label:"User Trigger",output:"A city built on the back of a giant turtle."}},{id:"2",type:"agent",x:500,y:150,data:{label:"Architect",role:"Outline the technical structure of this city.",temperature:.2,provider:"novita",model:"deepseek/deepseek-r1-turbo"}},{id:"3",type:"agent",x:500,y:450,data:{label:"Writer",role:"Turn the plan into a narrative intro.",temperature:.9,provider:"novita",model:"deepseek/deepseek-v3.2"}},{id:"4",type:"output",x:950,y:300,data:{label:"Final Output"}}],connections:[{id:"c1",from:"1",to:"2"},{id:"c2",from:"2",to:"3"},{id:"c3",from:"3",to:"4"}]},Vt={id:"flow-fusion",name:"Fusion Blueprint",description:"Multi-agent cross-branch integration engine",nodes:[{id:"f1",type:"input",x:80,y:300,data:{label:"Fusion Config",output:`SOURCE: feature/auth-v2
TARGET: main
GOAL: Migrate Google Auth to the new modular service.`}},{id:"f2",type:"agent",x:450,y:150,data:{label:"Drift Auditor",role:"You are the Code Auditor. Compare the SOURCE and TARGET requirements in the input. Identify architectural drift and missing files. Output a technical report.",temperature:.1,provider:"novita",model:"deepseek/deepseek-r1-turbo"}},{id:"f3",type:"agent",x:450,y:450,data:{label:"Merge Implementer",role:'You are the Implementer. Based on the audit, write the actual code for adapters and missing files. RETURN ONLY JSON format: { "explanation": "...", "files": [{ "path": "...", "content": "..." }] }',temperature:.2,provider:"novita",model:"deepseek/deepseek-v3.2"}},{id:"f4",type:"output",x:900,y:300,data:{label:"Final Patch",isPatch:!0}}],connections:[{id:"fc1",from:"f1",to:"f2"},{id:"fc2",from:"f2",to:"f3"},{id:"fc3",from:"f3",to:"f4"}]},Kt={id:"flow-ds-chat",name:"DS-Chat (dscide)",description:"Standard CLI Cortex + Executor architecture",nodes:[{id:"ds1",type:"input",x:100,y:300,data:{label:"User Request",output:"Analyze the current billing service and suggest a retry logic for Stripe failures."}},{id:"ds2",type:"agent",x:450,y:150,data:{label:"Cortex Router",role:`You are "Bilge Cortex", the intelligent workspace router.

Analyze the user prompt. Return a JSON object with:
1. "category": One of [reasoning, coding, general, low-latency, search].
2. "strategy": A 1-sentence instruction for the Assistant.
3. "needs_search": boolean. True if the prompt requires real-time/current data.
4. "search_query": A refined search string if needs_search is True.`,temperature:0,provider:"novita",model:"deepseek/deepseek-v3.2"}},{id:"ds3",type:"agent",x:450,y:450,data:{label:"DeepSeek Executor",role:`You are an advanced AI assistant with FULL ACCESS to the local filesystem.

DELEGATED CODING:
When the user wants code changes in this repo, prefer the file-scoped delegator.
You cannot run shell commands directly; instead, output a ready-to-run \`dscode delegate ...\` command for the user.`,temperature:.7,provider:"novita",model:"deepseek/deepseek-r1-turbo"}},{id:"ds4",type:"output",x:900,y:300,data:{label:"Final Response"}}],connections:[{id:"dsc1",from:"ds1",to:"ds2"},{id:"dsc2",from:"ds2",to:"ds3"},{id:"dsc3",from:"ds3",to:"ds4"}]},be={id:"flow-cortex-core",name:"Cortex Core Modules",description:"Router + complexity + executor + PM + guardian (prompts prefilled).",nodes:[{id:"c1",type:"input",x:100,y:180,data:{label:"User Request",output:"Implement a safe, fast DSCode edit engine that can create files and verify changes."}},{id:"c2",type:"agent",x:420,y:180,data:{label:"Orchestrator (Cortex Router)",role:`${C.prompts.router.system}

ROUTER USER TEMPLATE (reference):
${C.prompts.router.userTemplate}

Output ONLY JSON.`,temperature:0,provider:"novita",model:C.models.router}},{id:"c3",type:"agent",x:740,y:180,data:{label:"Intel Analyst (Complexity)",role:`${C.prompts.complexity.system}

COMPLEXITY USER TEMPLATE (reference):
${C.prompts.complexity.userTemplate}

Output ONLY JSON.`,temperature:0,provider:"novita",model:C.models.map["low-latency"]}},{id:"c4",type:"agent",x:740,y:420,data:{label:"Executor (DSCode)",role:`${C.prompts.executor.baseSystemTemplate}

PER-TURN INJECTION (reference):
${C.prompts.executor.turnInjectionTemplate}`,temperature:.7,provider:"novita",model:C.models.map.coding}},{id:"c5",type:"agent",x:420,y:420,data:{label:"Product Manager",role:`${C.prompts.pm.system}

PM USER TEMPLATE (reference):
${C.prompts.pm.userTemplate}

Output ONLY JSON.`,temperature:0,provider:"gemini",model:C.models.pm.primary}},{id:"c6",type:"agent",x:100,y:420,data:{label:"Guardian (Safety)",role:C.prompts.guardian.system,temperature:0,provider:"novita",model:C.models.map.general}},{id:"c7",type:"output",x:100,y:660,data:{label:"Final Output"}}],connections:[{id:"cc1",from:"c1",to:"c2"},{id:"cc2",from:"c2",to:"c3"},{id:"cc3",from:"c3",to:"c4"},{id:"cc4",from:"c4",to:"c5"},{id:"cc5",from:"c5",to:"c6"},{id:"cc6",from:"c6",to:"c7"}]},Zt=({node:i,isOpen:x,onClose:m,updateNode:l,deleteNode:E,novitaModels:p})=>{if(!x||!i)return null;const k=i.id.startsWith("intent-"),O=i.id==="router"||k,T=String(i.data.provider||"").trim()||"deepseek",g=T==="deepseek"?["deepseek-chat","deepseek-reasoner"]:T==="gemini"?["gemini-2.0-flash","gemini-2.0-pro"]:T==="openai"?["gpt-4o"]:[];return e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 animate-fade-in",onClick:m,children:e.jsxs("div",{className:"bg-white dark:bg-[#1C1C1E] w-full max-w-lg max-h-[85vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col border border-border",onClick:a=>a.stopPropagation(),children:[e.jsxs("div",{className:"h-16 border-b border-border flex items-center justify-between px-6 bg-surface/50 backdrop-blur-md shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`p-2 rounded-lg ${i.type==="input"?"bg-green-500/10 text-green-600":i.type==="output"?"bg-orange-500/10 text-orange-600":"bg-blue-500/10 text-blue-600"}`,children:i.type==="input"?e.jsx(ie,{size:20}):i.type==="output"?e.jsx(ye,{size:20}):e.jsx(we,{size:20})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-primary",children:i.data.label}),e.jsxs("p",{className:"text-xs text-secondary uppercase tracking-wider",children:[i.type," Node"]})]})]}),e.jsx("button",{onClick:m,className:"p-2 hover:bg-black/5 dark:hover:bg-white/5 rounded-full text-secondary hover:text-primary transition-colors",children:e.jsx(Pt,{size:20})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6 space-y-6",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"text-xs font-bold text-secondary uppercase tracking-wider",children:"Node Label"}),e.jsx("input",{type:"text",value:i.data.label,onChange:a=>l(i.id,{label:a.target.value}),className:"w-full bg-white dark:bg-black/10 border border-border rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-accent shadow-sm"})]}),i.type==="agent"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("label",{className:"text-xs font-bold text-secondary uppercase tracking-wider",children:k?"Intent Notes":"System Prompt"}),e.jsx("span",{className:"text-[10px] text-secondary bg-surface px-2 py-1 rounded",children:k?"Optional":"Instructions"})]}),e.jsx("textarea",{value:i.data.role,onChange:a=>l(i.id,{role:a.target.value}),className:"w-full h-32 bg-white dark:bg-black/10 border border-border rounded-xl px-4 py-3 text-sm resize-y focus:outline-none focus:border-accent leading-relaxed font-mono"})]}),k&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"text-xs font-bold text-secondary uppercase tracking-wider",children:"Description"}),e.jsx("input",{type:"text",value:i.data.description??"",onChange:a=>l(i.id,{description:a.target.value}),placeholder:"Short human-friendly description",className:"w-full bg-white dark:bg-black/10 border border-border rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-accent shadow-sm"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"text-xs font-bold text-secondary uppercase tracking-wider",children:"Strategy"}),e.jsx("textarea",{value:i.data.strategy??"",onChange:a=>l(i.id,{strategy:a.target.value}),placeholder:"Imperative strategy sentence",className:"w-full h-24 bg-white dark:bg-black/10 border border-border rounded-xl px-4 py-3 text-sm resize-y focus:outline-none focus:border-accent leading-relaxed font-mono"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"text-xs font-bold text-secondary uppercase tracking-wider",children:"Keywords"}),e.jsx("input",{type:"text",value:(i.data.keywords||[]).join(", "),onChange:a=>{const b=String(a.target.value||"").split(",").map(A=>A.trim()).filter(Boolean);l(i.id,{keywords:b})},placeholder:"comma, separated, keywords",className:"w-full bg-white dark:bg-black/10 border border-border rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-accent shadow-sm font-mono"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"text-xs font-bold text-secondary uppercase tracking-wider",children:"Complexity"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:i.data.complexity||"moderate",onChange:a=>l(i.id,{complexity:a.target.value}),className:"w-full bg-white dark:bg-black/10 border border-border rounded-xl px-4 py-3 text-sm appearance-none focus:outline-none focus:border-accent",children:[e.jsx("option",{value:"simple",children:"simple"}),e.jsx("option",{value:"moderate",children:"moderate"}),e.jsx("option",{value:"complex",children:"complex"})]}),e.jsx(G,{size:14,className:"absolute right-4 top-1/2 -translate-y-1/2 text-secondary pointer-events-none"})]})]})]}),O?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"text-xs font-bold text-secondary uppercase tracking-wider",children:"Brain Provider"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:T,onChange:a=>{const b=a.target.value;l(i.id,{provider:b})},className:"w-full bg-white dark:bg-black/10 border border-border rounded-xl px-4 py-3 text-sm appearance-none focus:outline-none focus:border-accent",children:[e.jsx("option",{value:"deepseek",children:"deepseek"}),e.jsx("option",{value:"gemini",children:"gemini"}),e.jsx("option",{value:"openai",children:"openai"}),e.jsx("option",{value:"backend",children:"backend"})]}),e.jsx(G,{size:14,className:"absolute right-4 top-1/2 -translate-y-1/2 text-secondary pointer-events-none"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"text-xs font-bold text-secondary uppercase tracking-wider",children:"Brain Model"}),e.jsx("input",{type:"text",list:"bilge-cortex-model-suggestions",value:i.data.model??"",onChange:a=>l(i.id,{model:a.target.value}),placeholder:"e.g. deepseek-chat",className:"w-full bg-white dark:bg-black/10 border border-border rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-accent shadow-sm font-mono"}),g.length>0?e.jsx("datalist",{id:"bilge-cortex-model-suggestions",children:g.map(a=>e.jsx("option",{value:a},a))}):null]})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"text-xs font-bold text-secondary uppercase tracking-wider",children:"Model"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:i.data.model,onChange:a=>{const b=a.target.value.includes("gemini")?"gemini":"novita";l(i.id,{model:a.target.value,provider:b})},className:"w-full bg-white dark:bg-black/10 border border-border rounded-xl px-4 py-3 text-sm appearance-none focus:outline-none focus:border-accent",children:[e.jsxs("optgroup",{label:"Google",children:[e.jsx("option",{value:"gemini-3-flash-preview",children:"Gemini 3 Flash"}),e.jsx("option",{value:"gemini-3-pro-preview",children:"Gemini 3 Pro"})]}),e.jsx("optgroup",{label:"Novita AI",children:p.map(a=>e.jsx("option",{value:a,children:a},a))})]}),e.jsx(G,{size:14,className:"absolute right-4 top-1/2 -translate-y-1/2 text-secondary pointer-events-none"})]})]})]}),e.jsx("div",{className:"pt-6 border-t border-border",children:e.jsxs("button",{onClick:()=>{E(i.id),m()},className:"w-full flex items-center justify-center gap-2 py-3 rounded-xl border border-red-500/20 text-red-500 hover:bg-red-500/10 transition-colors text-sm font-medium",children:[e.jsx(Ze,{size:16})," Delete Node"]})})]})]})})},ir=()=>{const{settings:i,updateSettings:x}=St(),m=c.useRef(null);if(!m.current){const t=[Xt,Vt,Kt,be],r=Gt(),s=qt(t,r),o=Ht()||be.id,n=s.find(d=>d.id===o)||s[0]||be;m.current={flows:s,activeFlowId:n.id,nodes:R(n.nodes),connections:R(n.connections)}}const[l,E]=c.useState(m.current.flows),[p,k]=c.useState(m.current.activeFlowId),[O,T]=c.useState(!1),[g,a]=c.useState(m.current.nodes),[b,A]=c.useState(m.current.connections),[S,F]=c.useState({x:0,y:0,zoom:1}),[P,rt]=c.useState(!1),[ve,le]=c.useState(null),[X,je]=c.useState(null),[H,ce]=c.useState(null),[st,ot]=c.useState([]),[M,ke]=c.useState(!1),[Ne,Se]=c.useState([]),[Ce,de]=c.useState(null),[Ee,z]=c.useState("idle"),[nt,Oe]=c.useState(0),[it,Te]=c.useState(0),[at,Re]=c.useState(""),[lt,V]=c.useState(null),[ct,dt]=c.useState(0),[Ie,K]=c.useState(!1),[ut,Pe]=c.useState(!1),[Z,_]=c.useState(!1),[Ae,q]=c.useState(!1),[I,U]=c.useState(!1),Q=c.useRef(null),h=c.useRef(null),pt=c.useRef(null),ue=c.useRef(null),ee=c.useRef(null),D=c.useRef(null);c.useEffect(()=>{Ct().then(ot)},[]),c.useEffect(()=>{ue.current&&ue.current.scrollIntoView({behavior:"smooth"})},[Ne]);const u=t=>Se(r=>[...r,`[${new Date().toLocaleTimeString()}] ${t}`]),Y=t=>u(`[ERROR] ${t}`),Fe=ge.useMemo(()=>g.some(t=>t.id.startsWith("intent-")),[g]),te=()=>Ft(String(i.mcpBaseUrl||""),"https://mcp.caravanflow.com"),re=()=>{const t=zt(String(i.mcpApiToken||"")),r={};return t&&(r.Authorization=`Bearer ${t}`),r},ze=()=>{const t=l.find(r=>r.id===p);return{id:String((t==null?void 0:t.id)||p||"").trim()||"flow",name:String((t==null?void 0:t.name)||"Flow").trim()||"Flow",description:String((t==null?void 0:t.description)||"").trim(),nodes:g.map(tt),connections:b.map(r=>({...r}))}},$e=t=>{E(r=>{const s=r.findIndex(n=>n.id===t.id),o=[...r];return s>=0?o[s]={...o[s],...t}:o.unshift(t),o})},xt=async()=>{if(I)return;U(!0),_(!0),q(!1);const t=te();try{u(`[cortex-sync] Pulling blueprint from ${t} ...`);const r=await fetch(`${t}/api/workflow/blueprint`,{method:"GET",headers:{...re(),Accept:"application/json"}});if(!r.ok){const n=await r.text();throw new Error(n||`HTTP ${r.status}`)}const s=await r.json();if(!s||!Array.isArray(s.nodes)||!Array.isArray(s.connections))throw new Error("Malformed blueprint payload (missing nodes/connections arrays).");const o={id:String(s.id||"cortex-blueprint").trim()||"cortex-blueprint",name:String(s.name||"Cortex Blueprint").trim()||"Cortex Blueprint",description:String(s.description||"").trim(),nodes:s.nodes,connections:s.connections};$e(o),a(R(o.nodes)),A(R(o.connections)),k(o.id),F({x:0,y:0,zoom:1});try{localStorage.setItem(ne,o.id)}catch{}u(`[cortex-sync] Pulled "${o.name}"${s.version?` (v${s.version})`:""}.`)}catch(r){Y(`[cortex-sync] Pull failed: ${String((r==null?void 0:r.message)||r||"Unknown error")}`)}finally{U(!1)}},Le=async()=>{if(I)return;U(!0),_(!0),q(!1);const t=te();try{const r=ze();u(`[cortex-sync] Publishing blueprint to ${t} ...`);const s=await fetch(`${t}/api/workflow/sync`,{method:"POST",headers:{...re(),"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(r)});if(!s.ok){const n=await s.text();throw new Error(n||`HTTP ${s.status}`)}const o=await s.json();u(`[cortex-sync] ${String((o==null?void 0:o.status)||"ok")}: ${String((o==null?void 0:o.message)||"").trim()||"Update applied."}`);try{const n=await We.executeTool("restart_extension_runtime",{});n!=null&&n.error?u(`[cortex-sync] Extension restart skipped: ${n.error}`):u("[cortex-sync] Extension runtime restart requested.")}catch(n){u(`[cortex-sync] Extension restart unavailable: ${String((n==null?void 0:n.message)||n||"")}`)}}catch(r){Y(`[cortex-sync] Publish failed: ${String((r==null?void 0:r.message)||r||"Unknown error")}`)}finally{U(!1)}},mt=async()=>{if(I||!window.confirm("Rollback Cortex logic to the most recent backup?"))return;U(!0),_(!0),q(!1);const r=te();try{u(`[cortex-sync] Rolling back via ${r} ...`);const s=await fetch(`${r}/api/workflow/rollback`,{method:"POST",headers:{...re(),"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({})});if(!s.ok){const n=await s.text();throw new Error(n||`HTTP ${s.status}`)}const o=await s.json();u(`[cortex-sync] ${String((o==null?void 0:o.status)||"ok")}: ${String((o==null?void 0:o.message)||"").trim()||"Rollback applied."}`);try{const n=await We.executeTool("restart_extension_runtime",{});n!=null&&n.error?u(`[cortex-sync] Extension restart skipped: ${n.error}`):u("[cortex-sync] Extension runtime restart requested.")}catch{}}catch(s){Y(`[cortex-sync] Rollback failed: ${String((s==null?void 0:s.message)||s||"Unknown error")}`)}finally{U(!1)}},ft=async()=>{if(I)return;U(!0),_(!0),q(!1);const t=te();try{u(`[cortex-sync] Fetching update history from ${t} ...`);const r=await fetch(`${t}/api/workflow/history`,{method:"GET",headers:{...re(),Accept:"application/json"}});if(!r.ok){const n=await r.text();throw new Error(n||`HTTP ${r.status}`)}const s=await r.json(),o=Array.isArray(s==null?void 0:s.history)?s.history:[];if(o.length===0){u("[cortex-sync] No update history.");return}u(`[cortex-sync] History entries: ${o.length}`);for(const n of o.slice(0,10)){const d=String((n==null?void 0:n.timestamp)||""),N=String((n==null?void 0:n.action)||""),f=String((n==null?void 0:n.from_version)||""),y=String((n==null?void 0:n.to_version)||""),J=f&&y?`${f} -> ${y}`:y||f||"";u(`- ${d} ${N} ${J}`.trim())}}catch(r){Y(`[cortex-sync] History fetch failed: ${String((r==null?void 0:r.message)||r||"Unknown error")}`)}finally{U(!1)}},ht=()=>{try{const t=ze(),r=`${JSON.stringify(t,null,2)}
`,s=new Blob([r],{type:"application/json"}),o=URL.createObjectURL(s),n=document.createElement("a");n.href=o,n.download=`${t.id||"flow"}.json`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(o),u(`[cortex-sync] Exported ${n.download}`)}catch(t){Y(`[cortex-sync] Export failed: ${String((t==null?void 0:t.message)||t||"Unknown error")}`)}},gt=async t=>{if(t)try{const r=await t.text(),s=JSON.parse(r);if(!s||!Array.isArray(s.nodes)||!Array.isArray(s.connections))throw new Error("Invalid JSON: expected {id,name,description,nodes[],connections[]}.");const o={id:String(s.id||"imported-flow").trim()||"imported-flow",name:String(s.name||"Imported Flow").trim()||"Imported Flow",description:String(s.description||"").trim(),nodes:s.nodes,connections:s.connections};$e(o),a(R(o.nodes)),A(R(o.connections)),k(o.id),F({x:0,y:0,zoom:1});try{localStorage.setItem(ne,o.id)}catch{}_(!0),u(`[cortex-sync] Imported "${o.name}".`)}catch(r){Y(`[cortex-sync] Import failed: ${String((r==null?void 0:r.message)||r||"Unknown error")}`)}finally{Q.current&&(Q.current.value="")}},bt=t=>{const r=l.find(s=>s.id===t);if(r){a(JSON.parse(JSON.stringify(r.nodes))),A(JSON.parse(JSON.stringify(r.connections))),k(t),T(!1),F({x:0,y:0,zoom:1});try{localStorage.setItem(ne,t)}catch{}}},B=ge.useMemo(()=>{const t=l.find(r=>r.id===p)||{id:p,name:"Custom Flow",description:"User-defined flow.",nodes:[],connections:[]};return Jt(t,g,b)},[l,p,g,b]),yt=ge.useMemo(()=>JSON.stringify({id:B.id,nodes:B.nodes,connections:B.connections}),[B]);c.useEffect(()=>{typeof window>"u"||E(t=>{const r=t.findIndex(o=>o.id===p),s=[...t];r>=0?s[r]={...s[r],nodes:B.nodes,connections:B.connections}:s.push(B);try{localStorage.setItem(et,JSON.stringify(s))}catch{}return s})},[yt,p]);const wt=async t=>{const r=g.find(s=>s.id===t);if(r!=null&&r.data.output)try{const s=r.data.output.replace(/^```json\s*/,"").replace(/\s*```$/,""),o=JSON.parse(s);o.files&&(u(`Applying ${o.files.length} files to workspace...`),await Lt.applyPatch(o.files),u("Merge Patch Applied Successfully."))}catch{u("Failed to parse or apply patch from node output.")}},pe=(t,r,s,o,n)=>{if(s==="node"&&P&&o){const d=g.find(N=>N.id===o);d&&(h.current={type:"node",startScreen:{x:t,y:r},startObj:{x:d.x,y:d.y},data:o}),le(o)}else if(s==="port"&&P&&o&&n){const d=g.find(y=>y.id===o);if(!d)return;const N=n==="source"?d.x+240:d.x,f=d.y+40;h.current={type:"connection",startScreen:{x:t,y:r},startObj:{x:N,y:f},data:{nodeId:o,type:n,startX:N,startY:f}},ce({x1:N,y1:f,x2:N,y2:f})}else h.current={type:"pan",startScreen:{x:t,y:r},startObj:{x:S.x,y:S.y}},s==="bg"&&le(null)},vt=(t,r)=>{if(!h.current)return;const s=t-h.current.startScreen.x,o=r-h.current.startScreen.y;if(h.current.type==="node"){const n=Math.round((h.current.startObj.x+s/S.zoom)/se)*se,d=Math.round((h.current.startObj.y+o/S.zoom)/se)*se;a(N=>N.map(f=>{var y;return f.id===((y=h.current)==null?void 0:y.data)?{...f,x:n,y:d}:f}))}else if(h.current.type==="pan")F({...S,x:h.current.startObj.x+s,y:h.current.startObj.y+o});else if(h.current.type==="connection"){const n=s/S.zoom,d=o/S.zoom;ce({x1:h.current.data.startX,y1:h.current.data.startY,x2:h.current.data.startX+n,y2:h.current.data.startY+d})}},xe=(t,r,s)=>{var o;if(((o=h.current)==null?void 0:o.type)==="connection"&&t==="port"&&r&&s){const n=h.current.data;if(n.nodeId!==r&&n.type!==s){const d=n.type==="source"?n.nodeId:r,N=n.type==="target"?n.nodeId:r;b.find(f=>f.from===d&&f.to===N)||(A(f=>[...f,{id:`c-${Date.now()}`,from:d,to:N}]),u(`Connected ${d} -> ${N}`))}}h.current=null,ce(null)},$=()=>{i.flowLiveHudEnabled&&i.flowLiveHudFlash&&(i.reducedMotion||dt(t=>t+1))},Me=()=>{if(!ee.current)return;z("cancelled");try{ee.current.abort()}catch{}const t=D.current;D.current=null,t==null||t(),u("Cancellation requested.")},_e=()=>{const t=D.current;D.current=null,t==null||t()},jt=t=>t.aborted?Promise.resolve():(K(!0),new Promise(r=>{const s=()=>{K(!1),D.current=null,r()};t.addEventListener("abort",s,{once:!0}),D.current=()=>{t.removeEventListener("abort",s),K(!1),r()}})),kt=async()=>{if(M)return;if(Fe){_(!0),z("error"),V("This is a Cortex sync blueprint (intent-*). Use Cortex Sync -> Publish instead of Execute."),Y("Cortex sync blueprints are not executable.");return}const t=new AbortController;ee.current=t;const r=t.signal,s=n=>{if(r.aborted||(n==null?void 0:n.name)==="AbortError")return!0;const d=String((n==null?void 0:n.message)||"");return/aborted|abort/i.test(d)};ke(!0),z("running"),V(null),Oe(0),Te(0),Re(""),$(),_(!0),Se(["> Initializing Intelligent Fusion Blueprint..."]),a(n=>n.map(d=>({...d,data:{...d.data,isProcessing:!1,output:d.type==="input"?d.data.output:""}})));let o="complete";try{const n=g.find(y=>y.type==="input");if(!n)throw new Error("No Input Node found.");let d=n.data.output||"",N=n.id;const f=[];for(let y=0;y<50;y++){const J=b.find(W=>W.from===N);if(!J)break;const w=g.find(W=>W.id===J.to);if(!w)break;f.push({conn:J,node:w}),N=w.id}if(Te(f.length),f.length===0){u("No outgoing connections. Nothing to execute."),z("complete"),$();return}for(let y=0;y<f.length;y++){if(r.aborted){o="cancelled";break}const{conn:J,node:w}=f[y],W=y+1;Oe(W),Re(w.data.label||w.id),de(J.id),a(v=>v.map(j=>j.id===w.id?{...j,data:{...j.data,isProcessing:!0}}:j)),$();try{if(w.type==="agent"){u(`Activating ${w.data.label}...`);let v="";const j=w.data.role||"You are a helpful assistant.",De=`Context:
${d}

Objective: Execute your specific instructions based on the context above.`,Ye=String(w.data.provider||"").trim().toLowerCase()==="gemini"?"gemini":"novita",Be=w.data.model||(Ye==="gemini"?"gemini-3-flash-preview":"deepseek/deepseek-r1-turbo"),Je=[{id:`flow-${w.id}-system`,role:"system",content:j,timestamp:Date.now()}];if(Ye==="novita"?await At(Je,De,fe=>{v+=fe,a(he=>he.map(L=>L.id===w.id?{...L,data:{...L.data,output:v}}:L))},Be,[],{enableThinking:i.enableThinking,abortSignal:r}):await $t(Je,De,fe=>{v+=fe,a(he=>he.map(L=>L.id===w.id?{...L,data:{...L.data,output:v}}:L))},{modelId:Be,enableThinking:i.enableThinking,abortSignal:r}),r.aborted){o="cancelled";break}d=v,u(`${w.data.label} finished.`)}else w.type==="output"&&(a(v=>v.map(j=>j.id===w.id?{...j,data:{...j.data,output:d}}:j)),u("Final fusion result received."))}catch(v){if(s(v)){o="cancelled";break}o="error";const j=String((v==null?void 0:v.message)||v||"Unknown error");V(j),z("error"),$(),u(`Error: ${j}`);break}finally{a(v=>v.map(j=>j.id===w.id?{...j,data:{...j.data,isProcessing:!1}}:j)),de(null)}if(o!=="complete")break;if(i.flowExecutionMode==="step"&&y<f.length-1){if(z("paused"),$(),await jt(r),r.aborted){o="cancelled";break}z("running"),$()}else await new Promise(v=>setTimeout(v,400))}o==="cancelled"?(z("cancelled"),$(),u("Sequence Cancelled.")):o==="complete"&&(z("complete"),$(),u("Sequence Complete."))}catch(n){o="error";const d=String((n==null?void 0:n.message)||n||"Unknown error");V(d),z("error"),$(),u(`Error: ${d}`)}finally{ee.current=null,D.current=null,K(!1),ke(!1),de(null),o==="error"&&u("Sequence Halted.")}},Ue=(t,r,s,o)=>{const n=Math.abs(s-t);return`M ${t} ${r} C ${t+n*.5} ${r} ${s-n*.5} ${o} ${s} ${o}`},me=l.find(t=>t.id===p);return e.jsxs("div",{className:"flex w-full h-full bg-[#111] overflow-hidden flex-col relative select-none",children:[e.jsx("input",{ref:Q,type:"file",accept:"application/json",className:"hidden",onChange:t=>{var s;const r=(s=t.target.files)==null?void 0:s[0];r&&gt(r)}}),e.jsx(Zt,{node:g.find(t=>t.id===ve),isOpen:ut,onClose:()=>Pe(!1),updateNode:(t,r)=>a(s=>s.map(o=>o.id===t?{...o,data:{...o.data,...r}}:o)),deleteNode:t=>{a(r=>r.filter(s=>s.id!==t)),A(r=>r.filter(s=>s.from!==t&&s.to!==t))},novitaModels:st}),i.flowLiveHudEnabled&&M&&e.jsx(Bt,{mode:i.flowExecutionMode,stage:Ee==="idle"?"running":Ee,stepIndex:nt,totalSteps:it,currentLabel:at,error:lt,flashEnabled:i.flowLiveHudFlash&&!i.reducedMotion,flashToken:ct,onCancel:Me,onContinue:Ie?_e:void 0}),e.jsxs("div",{className:"h-14 bg-white dark:bg-[#1C1C1E] border-b border-border flex items-center justify-between px-6 z-30 shrink-0",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"p-2 bg-indigo-500/10 rounded-lg text-indigo-600",children:e.jsx(Mt,{size:18})}),e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:()=>T(!O),className:"flex items-center gap-2 px-2 py-1 rounded-lg transition-colors hover:bg-black/5 dark:hover:bg-white/5",children:e.jsxs("div",{className:"flex flex-col items-start",children:[e.jsx("span",{className:"text-xs font-bold text-secondary uppercase tracking-wider",children:"Active Pattern"}),e.jsxs("span",{className:"text-sm font-semibold text-primary flex items-center gap-2",children:[me==null?void 0:me.name," ",e.jsx(G,{size:12})]})]})}),O&&e.jsx("div",{className:"absolute top-full left-0 mt-2 w-64 bg-white dark:bg-[#2C2C2E] border border-border rounded-xl shadow-xl z-50 p-1 animate-fade-in",children:l.map(t=>e.jsxs("button",{onClick:()=>bt(t.id),className:`w-full text-left px-3 py-2.5 rounded-lg text-xs flex items-center gap-3 transition-colors ${p===t.id?"bg-indigo-50 dark:bg-indigo-500/20 text-indigo-600":"hover:bg-black/5 text-primary"}`,children:[t.id.includes("fusion")?e.jsx(Xe,{size:14}):e.jsx(ye,{size:14}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:t.name}),e.jsx("span",{className:"text-[9px] opacity-70",children:t.description})]})]},t.id))})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("button",{onClick:()=>rt(!P),className:`flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${P?"bg-orange-500/10 text-orange-600 ring-1 ring-orange-500/50":"bg-surface text-secondary hover:text-primary"}`,children:[P?e.jsx(Et,{size:14}):e.jsx(Ot,{size:14}),P?"Blueprint Unlocked":"Blueprint Locked"]}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>q(t=>!t),className:`flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${Ae?"bg-indigo-500/10 text-indigo-600 ring-1 ring-indigo-500/40":"bg-surface text-secondary hover:text-primary"}`,title:"Pull/publish Cortex intent logic to the Bilge agent (chrome-extension-bilge/cortex.js).",children:[e.jsx(Ge,{size:14}),"Cortex Sync",e.jsx(G,{size:12})]}),Ae&&e.jsxs("div",{className:"absolute top-full right-0 mt-2 w-72 bg-white dark:bg-[#2C2C2E] border border-border rounded-xl shadow-xl z-50 p-1 animate-fade-in",children:[e.jsxs("button",{onClick:()=>void xt(),disabled:I,className:"w-full text-left px-3 py-2.5 rounded-lg text-xs flex items-center gap-3 transition-colors hover:bg-black/5 text-primary disabled:opacity-50",children:[e.jsx(Ve,{size:14}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:"Pull From Agent"}),e.jsx("span",{className:"text-[9px] opacity-70",children:"Load current cortex.js intents as a blueprint"})]})]}),e.jsxs("button",{onClick:()=>void Le(),disabled:I,className:"w-full text-left px-3 py-2.5 rounded-lg text-xs flex items-center gap-3 transition-colors hover:bg-black/5 text-primary disabled:opacity-50",children:[e.jsx(He,{size:14}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:"Publish To Agent"}),e.jsx("span",{className:"text-[9px] opacity-70",children:"Apply blueprint to cortex.js (backup + bump version)"})]})]}),e.jsxs("button",{onClick:()=>void ft(),disabled:I,className:"w-full text-left px-3 py-2.5 rounded-lg text-xs flex items-center gap-3 transition-colors hover:bg-black/5 text-primary disabled:opacity-50",children:[e.jsx(Ke,{size:14}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:"History"}),e.jsx("span",{className:"text-[9px] opacity-70",children:"Show last update transactions"})]})]}),e.jsxs("button",{onClick:()=>void mt(),disabled:I,className:"w-full text-left px-3 py-2.5 rounded-lg text-xs flex items-center gap-3 transition-colors hover:bg-rose-500/10 text-rose-600 disabled:opacity-50",children:[e.jsx(Ze,{size:14}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:"Rollback"}),e.jsx("span",{className:"text-[9px] opacity-70",children:"Restore cortex.js from most recent backup"})]})]}),e.jsx("div",{className:"h-px bg-border my-1"}),e.jsxs("button",{onClick:ht,className:"w-full text-left px-3 py-2.5 rounded-lg text-xs flex items-center gap-3 transition-colors hover:bg-black/5 text-primary",children:[e.jsx(Ve,{size:14}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:"Export JSON"}),e.jsx("span",{className:"text-[9px] opacity-70",children:"Download the current blueprint"})]})]}),e.jsxs("button",{onClick:()=>{var t;return(t=Q.current)==null?void 0:t.click()},className:"w-full text-left px-3 py-2.5 rounded-lg text-xs flex items-center gap-3 transition-colors hover:bg-black/5 text-primary",children:[e.jsx(qe,{size:14}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:"Import JSON"}),e.jsx("span",{className:"text-[9px] opacity-70",children:"Load a blueprint file into the canvas"})]})]})]})]}),e.jsxs("button",{onClick:()=>x({enableThinking:!i.enableThinking}),className:`flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${i.enableThinking?"bg-indigo-500/10 text-indigo-600 ring-1 ring-indigo-500/40":"bg-surface text-secondary hover:text-primary"}`,title:"Thinking mode allows models to reason visibly in their own style (when supported).",children:[e.jsx(Ge,{size:14}),i.enableThinking?"Thinking ON":"Thinking OFF"]}),e.jsxs("button",{onClick:()=>x({flowExecutionMode:i.flowExecutionMode==="step"?"batch":"step"}),className:`flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${i.flowExecutionMode==="step"?"bg-cyan-500/10 text-cyan-600 ring-1 ring-cyan-500/40":"bg-surface text-secondary hover:text-primary"}`,title:"Batch runs continuously. Stepwise pauses between nodes with Continue.",children:[i.flowExecutionMode==="step"?e.jsx(ie,{size:14}):e.jsx(we,{size:14}),i.flowExecutionMode==="step"?"Stepwise":"Batch"]}),e.jsxs("button",{onClick:()=>x({flowLiveHudEnabled:!i.flowLiveHudEnabled}),className:`flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${i.flowLiveHudEnabled?"bg-indigo-500/10 text-indigo-600 ring-1 ring-indigo-500/40":"bg-surface text-secondary hover:text-primary"}`,title:"Show live execution HUD overlay during runs.",children:[e.jsx(Ke,{size:14}),"HUD"]}),e.jsxs("button",{disabled:i.reducedMotion,onClick:()=>{const t=!(i.flowLiveHudFlash||i.flowFlashUiEnabled);x({flowLiveHudFlash:t,flowFlashUiEnabled:t})},className:`flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${i.reducedMotion?"bg-surface text-secondary/40 cursor-not-allowed":i.flowLiveHudFlash||i.flowFlashUiEnabled?"bg-amber-500/10 text-amber-600 ring-1 ring-amber-500/40":"bg-surface text-secondary hover:text-primary"}`,title:i.reducedMotion?"Reduced motion is enabled.":"Flash the HUD and active nodes on step changes.",children:[e.jsx(Tt,{size:14}),"Flash"]}),X&&P&&e.jsx("button",{onClick:()=>{A(t=>t.filter(r=>r.id!==X)),je(null)},className:"px-3 py-1.5 bg-red-500/10 text-red-600 rounded-lg text-xs font-bold",children:e.jsx(Yt,{size:14})}),e.jsx("div",{className:"h-6 w-px bg-border mx-2"}),Fe?e.jsxs("button",{onClick:()=>void Le(),disabled:I,className:`px-5 py-2 rounded-lg font-bold text-xs shadow-lg flex items-center gap-2 transition-all hover:scale-105 ${I?"bg-secondary/20 text-secondary cursor-not-allowed":"bg-gradient-to-r from-indigo-600 to-blue-600 text-white"}`,title:"Publish this Cortex sync blueprint to update chrome-extension-bilge/cortex.js",children:[I?e.jsx(oe,{size:14,className:"animate-spin"}):e.jsx(He,{size:14}),I?"Publishing...":"Publish Cortex Update"]}):e.jsxs("button",{onClick:kt,disabled:M,className:`px-5 py-2 rounded-lg font-bold text-xs shadow-lg flex items-center gap-2 transition-all hover:scale-105 ${M?"bg-secondary/20 text-secondary cursor-not-allowed":"bg-gradient-to-r from-blue-600 to-purple-600 text-white"}`,children:[M?e.jsx(oe,{size:14,className:"animate-spin"}):e.jsx(Dt,{size:14,fill:"currentColor"}),M?"Processing...":"Execute Blueprint"]}),M&&i.flowExecutionMode==="step"&&Ie&&e.jsx("button",{onClick:_e,className:"px-4 py-2 rounded-lg font-bold text-xs shadow-lg flex items-center gap-2 transition-all bg-indigo-500/10 text-indigo-600 ring-1 ring-indigo-500/30 hover:bg-indigo-500/15",title:"Continue to next step",children:"Continue"}),M&&e.jsxs("button",{onClick:Me,className:"px-4 py-2 rounded-lg font-bold text-xs shadow-lg flex items-center gap-2 transition-all bg-rose-500/10 text-rose-600 ring-1 ring-rose-500/30 hover:bg-rose-500/15",title:"Stop execution",children:[e.jsx(Qe,{size:14}),"Stop"]})]})]}),e.jsxs("div",{className:"flex-1 relative overflow-hidden bg-[#F5F5F7] dark:bg-[#111] touch-none",children:[e.jsx("div",{ref:pt,className:"w-full h-full cursor-grab active:cursor-grabbing overflow-hidden",onPointerDown:t=>{t.preventDefault(),pe(t.clientX,t.clientY,"bg")},onPointerMove:t=>vt(t.clientX,t.clientY),onPointerUp:()=>xe(),onPointerCancel:()=>xe(),onWheel:t=>F(r=>({...r,zoom:Math.min(Math.max(.2,r.zoom+-t.deltaY*.001),2)})),children:e.jsxs("div",{className:"w-full h-full origin-top-left",style:{transform:`translate(${S.x}px, ${S.y}px) scale(${S.zoom})`},children:[e.jsx("div",{className:"absolute -left-[5000px] -top-[5000px] w-[10000px] h-[10000px] opacity-[0.4] pointer-events-none",style:{backgroundImage:"radial-gradient(circle, #888 1px, transparent 1px)",backgroundSize:"20px 20px"}}),e.jsxs("svg",{className:"absolute -left-[5000px] -top-[5000px] w-[10000px] h-[10000px] pointer-events-none z-0",children:[b.map(t=>{const r=g.find(n=>n.id===t.from),s=g.find(n=>n.id===t.to);if(!r||!s)return null;const o=Ue(r.x+240+5e3,r.y+40+5e3,s.x+5e3,s.y+40+5e3);return e.jsxs("g",{className:"pointer-events-auto cursor-pointer",onClick:n=>{n.stopPropagation(),je(t.id)},children:[e.jsx("path",{d:o,stroke:"transparent",strokeWidth:"20",fill:"none"}),e.jsx("path",{d:o,stroke:Ce===t.id?"#6366F1":X===t.id?"#F97316":"var(--col-border)",strokeWidth:X===t.id?"4":"3",fill:"none",className:"transition-all duration-300"}),Ce===t.id&&e.jsx("circle",{r:"4",fill:"#6366F1",children:e.jsx("animateMotion",{dur:"0.8s",repeatCount:"indefinite",path:o})})]},t.id)}),H&&e.jsx("path",{d:Ue(H.x1+5e3,H.y1+5e3,H.x2+5e3,H.y2+5e3),stroke:"#F97316",strokeWidth:"3",strokeDasharray:"5,5",fill:"none"})]}),g.map(t=>e.jsxs("div",{className:`absolute relative w-[240px] rounded-2xl bg-white dark:bg-[#1C1C1E] border shadow-sm p-0 transition-all duration-200 z-10 ${ve===t.id?"ring-2 ring-accent border-transparent shadow-xl":"border-border"} ${t.data.isProcessing?"ring-2 ring-green-500 shadow-[0_0_15px_rgba(34,197,94,0.3)]":""}`,style:{left:t.x,top:t.y},onPointerDown:r=>{r.stopPropagation(),r.preventDefault(),pe(r.clientX,r.clientY,"node",t.id)},onDoubleClick:()=>{le(t.id),Pe(!0)},children:[i.flowFlashUiEnabled&&!i.reducedMotion&&t.data.isProcessing?e.jsx("div",{className:"absolute inset-0 pointer-events-none rounded-2xl bg-indigo-500/10 bilge-exec-flash"}):null,e.jsxs("div",{className:`px-4 py-3 border-b border-border rounded-t-2xl flex items-center justify-between ${t.type==="input"?"bg-green-500/5":t.type==="output"?"bg-orange-500/5":"bg-blue-500/5"}`,children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[t.id.startsWith("f")?e.jsx(Xe,{size:14,className:"text-indigo-600"}):t.type==="input"?e.jsx(ie,{size:14,className:"text-green-600"}):e.jsx(ye,{size:14}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-xs font-bold text-primary truncate max-w-[170px]",children:t.data.label}),t.type==="agent"?e.jsxs("div",{className:"text-[9px] text-secondary font-mono truncate max-w-[170px] opacity-70",children:[t.data.provider||"novita",": ",t.data.model||"(default)"]}):null]})]}),t.data.isProcessing&&e.jsx(oe,{size:12,className:"animate-spin text-primary"})]}),e.jsxs("div",{className:"p-4 space-y-2 text-[10px] font-mono overflow-hidden",children:[t.type==="input"?e.jsx("textarea",{className:"w-full h-20 bg-surface border border-border rounded-lg p-2 resize-none focus:outline-none focus:border-accent",value:t.data.output,onChange:r=>a(s=>s.map(o=>o.id===t.id?{...o,data:{...o.data,output:r.target.value}}:o))}):e.jsx("div",{className:"h-32 bg-surface rounded-lg p-2 overflow-y-auto border border-border whitespace-pre-wrap leading-relaxed opacity-80",children:t.data.output?t.data.output:t.type==="agent"&&t.data.role?e.jsxs("span",{className:"opacity-70",children:[e.jsx("span",{className:"block text-[9px] font-bold uppercase tracking-widest opacity-50",children:"System prompt"}),Wt(t.data.role)]}):e.jsx("span",{className:"italic opacity-30",children:"Idle..."})}),t.data.isPatch&&t.data.output&&e.jsxs("button",{onClick:()=>wt(t.id),className:"w-full flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 text-white py-1.5 rounded-lg font-bold text-[9px] transition-colors shadow-sm",children:[e.jsx(Rt,{size:10})," Apply Patch to VFS"]})]}),t.type!=="output"&&e.jsx("div",{className:`absolute top-1/2 -right-3 -translate-y-1/2 w-6 h-6 bg-surface border border-border rounded-full flex items-center justify-center z-20 shadow-sm ${P?"cursor-crosshair":"opacity-20 pointer-events-none"}`,onPointerDown:r=>{r.stopPropagation(),r.preventDefault(),P&&pe(r.clientX,r.clientY,"port",t.id,"source")},children:e.jsx("div",{className:"w-1.5 h-1.5 bg-secondary rounded-full"})}),t.type!=="input"&&e.jsx("div",{className:`absolute top-1/2 -left-3 -translate-y-1/2 w-6 h-6 bg-surface border border-border rounded-full flex items-center justify-center z-20 shadow-sm ${P?"cursor-crosshair":"opacity-20 pointer-events-none"}`,onPointerUp:r=>{r.stopPropagation(),r.preventDefault(),P&&xe("port",t.id,"target")},children:e.jsx("div",{className:"w-1.5 h-1.5 bg-secondary rounded-full"})})]},t.id))]})}),e.jsxs("div",{className:"absolute bottom-12 right-6 z-20 flex flex-col gap-2",children:[e.jsxs("div",{className:"bg-white dark:bg-[#1C1C1E] border border-border rounded-lg shadow-lg flex flex-col p-1",children:[e.jsx("button",{onClick:()=>F(t=>({...t,zoom:Math.min(t.zoom+.1,2)})),className:"p-2 hover:bg-surface rounded-md",children:e.jsx(qe,{size:16})}),e.jsx("button",{onClick:()=>F(t=>({...t,zoom:Math.max(t.zoom-.1,.2)})),className:"p-2 hover:bg-surface rounded-md",children:e.jsx(Ut,{size:16})})]}),e.jsx("button",{onClick:()=>F({x:0,y:0,zoom:1}),className:"bg-white dark:bg-[#1C1C1E] border border-border rounded-lg shadow-lg p-3",children:e.jsx(_t,{size:16})})]}),e.jsxs("div",{className:`border-t border-border bg-[#09090b] flex flex-col shrink-0 transition-all duration-300 z-20 ${Z?"h-48":"h-8"}`,children:[e.jsxs("div",{className:"h-8 border-b border-white/10 flex items-center px-4 justify-between bg-white/5 cursor-pointer",onClick:()=>_(!Z),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(It,{size:12,className:"text-secondary"}),e.jsx("span",{className:"text-[10px] font-mono text-secondary uppercase",children:"Execution Log"})]}),e.jsx(G,{size:14,className:`text-secondary transition-transform ${Z?"":"rotate-180"}`})]}),Z&&e.jsxs("div",{className:"flex-1 overflow-y-auto p-3 font-mono text-[10px] text-gray-300 space-y-1",children:[Ne.map((t,r)=>e.jsx("div",{children:t},r)),e.jsx("div",{ref:ue})]})]})]})]})};export{ir as FlowPage};
