import{c as ne,k as fr,m as X,G as xr,g as hr,r as a,j as e,X as kt,a as gr,C as br,L as qe,D as yr,B as Xt,Z as Fs,S as Us,T as wr,b as St,u as vr,d as kr,e as ys,f as Wt,R as ws,P as Sr,s as vs}from"./index-nioxCw3b.js";import{S as jr,s as ks}from"./geminiService-BpM_s6Vu.js";import{t as Nr,F as Cr,k as Ss,A as js,a as Er,b as Mr}from"./ArtifactPanel-FFcv7Mbj.js";import{M as Ar,r as Tr,f as Ns,S as $r,C as Rr}from"./index-B1pO6E6u.js";import{A as Cs}from"./activity-GXyd6ffo.js";import{M as _r,C as Yt}from"./maximize-2-DKnnPGEQ.js";import{L as Gs}from"./layers-BpYWplLs.js";import{p as Ir,R as Dr}from"./parsing-CY11QkzD.js";/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Lr=ne("ArchiveRestore",[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h2",key:"tvwodi"}],["path",{d:"M20 8v11a2 2 0 0 1-2 2h-2",key:"1gkqxj"}],["path",{d:"m9 15 3-3 3 3",key:"1pd0qc"}],["path",{d:"M12 12v9",key:"192myk"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Or=ne("Archive",[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8",key:"1s80jp"}],["path",{d:"M10 12h4",key:"a56b0p"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pr=ne("ArrowRightLeft",[["path",{d:"m16 3 4 4-4 4",key:"1x1c3m"}],["path",{d:"M20 7H4",key:"zbl0bi"}],["path",{d:"m8 21-4-4 4-4",key:"h9nckh"}],["path",{d:"M4 17h16",key:"g4d7ey"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const jt=ne("BookOpenCheck",[["path",{d:"M12 21V7",key:"gj6g52"}],["path",{d:"m16 12 2 2 4-4",key:"mdajum"}],["path",{d:"M22 6V4a1 1 0 0 0-1-1h-5a4 4 0 0 0-4 4 4 4 0 0 0-4-4H3a1 1 0 0 0-1 1v13a1 1 0 0 0 1 1h6a3 3 0 0 1 3 3 3 3 0 0 1 3-3h6a1 1 0 0 0 1-1v-1.3",key:"8arnkb"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zr=ne("CircleDot",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fr=ne("Ellipsis",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"19",cy:"12",r:"1",key:"1wjl8i"}],["circle",{cx:"5",cy:"12",r:"1",key:"1pcz8c"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Es=ne("Folder",[["path",{d:"M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z",key:"1kt360"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ur=ne("Image",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Gr=ne("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Br=ne("MessageSquareText",[["path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",key:"1lielz"}],["path",{d:"M13 8H7",key:"14i4kc"}],["path",{d:"M17 12H7",key:"16if0g"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Hr=ne("Minimize2",[["polyline",{points:"4 14 10 14 10 20",key:"11kfnr"}],["polyline",{points:"20 10 14 10 14 4",key:"rlmsce"}],["line",{x1:"14",x2:"21",y1:"10",y2:"3",key:"o5lafz"}],["line",{x1:"3",x2:"10",y1:"21",y2:"14",key:"1atl0r"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Kt=ne("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wr=ne("Route",[["circle",{cx:"6",cy:"19",r:"3",key:"1kj8tv"}],["path",{d:"M9 19h8.5a3.5 3.5 0 0 0 0-7h-11a3.5 3.5 0 0 1 0-7H15",key:"1d8sl"}],["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yr=ne("Share2",[["circle",{cx:"18",cy:"5",r:"3",key:"gq8acd"}],["circle",{cx:"6",cy:"12",r:"3",key:"w7nqdw"}],["circle",{cx:"18",cy:"19",r:"3",key:"1xt0gg"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49",key:"47mynk"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49",key:"1n3mei"}]]);/**
 * @license lucide-react v0.460.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ms=ne("Watch",[["circle",{cx:"12",cy:"12",r:"6",key:"1vlfrh"}],["polyline",{points:"12 10 12 12 13 13",key:"19dquz"}],["path",{d:"m16.13 7.66-.81-4.05a2 2 0 0 0-2-1.61h-2.68a2 2 0 0 0-2 1.61l-.78 4.05",key:"18k57s"}],["path",{d:"m7.88 16.36.8 4a2 2 0 0 0 2 1.61h2.72a2 2 0 0 0 2-1.61l.81-4.05",key:"16ny36"}]]),we="deepseek/deepseek-v3.2",Bs=`- Root: /Users/rustamhudaygulyyev/Code/applets
- Focus: personal toolbox for audio/transcription/translation/TTS/dubbing plus web automation workspaces.
- Primary policy file: AGENTS.md at repo root.
- Default operating posture: pragmatic, reproducible, low-risk changes with explicit verification.`,Kr=r=>{const n=String(r||"").trim();if(!n)return null;const o=n.toLowerCase().replace(/\s+/g," ").trim(),c=/\b(read|open|load|follow|apply|use|sync)\s+(the\s+)?(agents|agnets|agent)(?:\.?\s*md)?\b/i,i=/^(agents|agnets|agent)(?:\.?\s*md)?$/i;return!c.test(o)&&!i.test(o)?null:{normalizedCommand:"read AGENTS.md",reason:"Detected AGENTS guidance mode-switch request."}},qr=r=>{const n=Array.isArray(r)?r:[],o=c=>n.filter(f=>c.test(String(f||""))).sort((f,m)=>f.length-m.length)[0]||"";return o(/(^|\/)AGENTS\.md$/i)||o(/(^|\/)AGENTS\.override\.md$/i)||o(/(^|\/)agent\.md$/i)||"AGENTS.md"},Vr=(r,n=6e3)=>{const o=String(r||"").trim();return o?o.length<=n?o:`${o.slice(0,n)}
...[truncated for context size]`:""},Xr=(r,n,o,c)=>{const i=Vr(c,6e3);return`<SystemContext>
### MODE SWITCH: AGENTS_GUIDANCE
Runtime: ${String(n.runtime||"web")}
DOM Mode: ${n.domModeEnabled?"enabled":"disabled"}
Browser Automation: ${n.browserAutomationAvailable===!1?"not available":"available"}

APPLETS WORKSPACE BRIEF:
${Bs}

REQUEST NORMALIZATION:
- User requested: "${r.normalizedCommand}"
- Treat this as a policy-first mode switch.

EXECUTION RULES:
- First action: read_file path="${o}".
- Apply AGENTS.md guardrails before any code or automation changes.
- Prefer concrete execution plans and verified results.

${i?`AGENTS GUIDANCE (CLIPPED):
${i}`:'AGENTS GUIDANCE: not currently available in VFS; attempt read_file("AGENTS.md") from repo root.'}
</SystemContext>`},Jr=r=>{const n=String(r||"").toLowerCase().trim();return n?!!(/\b(analy[sz]e|analysis|summar(y|ize)|implementation|implement|architecture|explain|compare|research|refactor|debug|patch|test(?:ing)?|plan|create\s+(?:an?\s+)?(?:html|js|ts|css|json|md|markdown|file)|html\s+file|xterm|terminal|generate\s+(?:an?\s+)?(?:report|summary|file)|write\s+a\s+summary|open\s+it\s+in\s+browser)\b/i.test(n)||/\b\w+\.(html|js|ts|tsx|css|json|md)\b/i.test(n)||n.split(/\s+/).filter(Boolean).length>=18&&/\b(and|then|after|while|about|implementation)\b/i.test(n)):!1},Zr=r=>{const n=String(r||"").trim();if(!n)return null;const o=n.toLowerCase(),c=/\b(open|current|this)\s+(tab|page)\b/i.test(o)||/\bin\s+(the\s+)?open\s+tab\b/i.test(o)||/\bon\s+(this|the)\s+(tab|page)\b/i.test(o)||/\bactive\s+tab\b/i.test(o),i=/\b(examine|inspect|analy[sz]e|debug|investigate|review|check)\b/i.test(o),f=/\b(scroll|xterm|terminal|dom|element|layout|ui|viewport|console)\b/i.test(o);return Jr(o)&&!(c&&(i||f))?null:/\b(screenshot|screen\s*shot|capture\s*(the\s*)?(screen|page)|take\s*(a\s*)?screenshot)\b/i.test(o)?{kind:"screenshot",normalizedCommand:"take a screenshot",preferredTool:"take_screenshot",suggestedGear:"search",suggestedModel:we,reason:"Detected screenshot/capture intent in extension runtime."}:c&&(i||f)?{kind:"analyze_page",normalizedCommand:n,preferredTool:"take_screenshot",suggestedGear:"search",suggestedModel:we,reason:"Detected explicit in-tab analysis intent in extension runtime."}:/\b(scroll\s*(to\s*)?(the\s*)?(top|beginning|start)|page\s*up)\b/i.test(o)?{kind:"scroll_top",normalizedCommand:"scroll to top",preferredTool:"execute_natural_command",suggestedGear:"low-latency",suggestedModel:we,reason:"Detected explicit page-scroll intent (top)."}:/\b(scroll\s*(to\s*)?(the\s*)?(bottom|end)|page\s*down)\b/i.test(o)?{kind:"scroll_bottom",normalizedCommand:"scroll to bottom",preferredTool:"execute_natural_command",suggestedGear:"low-latency",suggestedModel:we,reason:"Detected explicit page-scroll intent (bottom)."}:/\bscroll\s*up\b/i.test(o)?{kind:"scroll_up",normalizedCommand:"scroll up",preferredTool:"execute_natural_command",suggestedGear:"low-latency",suggestedModel:we,reason:"Detected natural-language scroll-up command."}:/\bscroll\s*down\b/i.test(o)?{kind:"scroll_down",normalizedCommand:"scroll down",preferredTool:"execute_natural_command",suggestedGear:"low-latency",suggestedModel:we,reason:"Detected natural-language scroll-down command."}:/\b(click|tap|press|select)\b/i.test(o)?{kind:"click",normalizedCommand:n,preferredTool:"execute_natural_command",suggestedGear:"low-latency",suggestedModel:we,reason:"Detected click/tap interaction intent."}:/\b(type|enter|input|fill(?:\s+in)?|set)\b/i.test(o)||/\bwrite\s+.+\s+(?:into|in|to)\b/i.test(o)?{kind:"type",normalizedCommand:n,preferredTool:"execute_natural_command",suggestedGear:"low-latency",suggestedModel:we,reason:"Detected typing/data-entry interaction intent."}:/\b(go\s*back|go\s*forward|navigate|refresh|reload|back|forward)\b/i.test(o)?{kind:"navigate",normalizedCommand:n,preferredTool:"execute_natural_command",suggestedGear:"low-latency",suggestedModel:we,reason:"Detected navigation intent."}:/\b(wait|pause|sleep)\b/i.test(o)?{kind:"wait",normalizedCommand:n,preferredTool:"execute_natural_command",suggestedGear:"low-latency",suggestedModel:we,reason:"Detected wait/pause command intent."}:null},Qr=(r,n)=>{const o=r.kind==="analyze_page"?["- This is an in-tab analysis request. Stay in browser context.",'- First action: call "get_browser_context" with {}.','- Then use "take_screenshot" and/or "explore_browser_dom" to inspect behavior.','- Use "get_element_value" or "run_script_direct" only if screenshot/DOM inspection is insufficient.',"- Do not call read_file/tree/execute_shell_command unless the user explicitly asks for repository files.","- After tool execution, return concise findings and one clear next diagnostic step."].join(`
`):["- This is a browser-control command. Prefer direct tool execution over long prose.",'- For scrolling/clicking/typing/navigation/wait commands, call "execute_natural_command" with:',`  {"command":"${r.normalizedCommand.replace(/"/g,'\\"')}"}`,'- For screenshots, call "take_screenshot" with {}.',"- After tool execution, return a concise confirmation and outcome."].join(`
`);return`<SystemContext>
### EXTENSION RUNTIME CONTEXT
Runtime: extension
DOM Mode: ${n.domModeEnabled?"enabled":"disabled"}
Browser Automation: ${n.browserAutomationAvailable?"available":"not available"}

DETECTED USER INTENT: ${r.kind}
NORMALIZED COMMAND: "${r.normalizedCommand}"
PREFERRED TOOL: ${r.preferredTool}
PREFERRED MODEL: ${r.suggestedModel}

EXECUTION RULES:
${o}
</SystemContext>`};class en{async resolveIntelligentContext(n,o,c="deepseek/deepseek-v3.2",i={}){const f=Date.now();if(!fr.isServiceActive("cortex"))return{status:"error",timestamp:f,error:{code:"SERVICE_INACTIVE",message:"Cortex intelligence module is disabled.",source:"ContextService",retryable:!1}};const p=String(i.runtime||"web").trim().toLowerCase()==="extension"&&i.browserAutomationAvailable!==!1,z=X.listAllFiles(),ie=Kr(n);if(ie){const D=qr(z),U=X.getGlobalGuidance(),R=Xr(ie,i,D,U);return{status:"success",timestamp:Date.now(),data:{relevantApplets:[D],summaryOfPastDecisions:"AGENTS mode-switch intent detected.",systemPromptAddon:R,confidence:.99,suggestedGear:"coding",suggestedProvider:"novita",suggestedModel:"deepseek/deepseek-r1-turbo",reason:ie.reason}}}const b=p?Zr(n):null;if(b){const D=Qr(b,i);return{status:"success",timestamp:Date.now(),data:{relevantApplets:[],summaryOfPastDecisions:"Extension runtime command intent detected.",systemPromptAddon:D,confidence:.98,suggestedGear:b.suggestedGear,suggestedProvider:"novita",suggestedModel:b.suggestedModel,reason:b.reason}}}const G=z.map(D=>`- ${D}`).join(`
`),C=`
            You are "Bilge Cortex", the intelligent workspace router.

            APPLETS WORKSPACE BRIEF:
            ${Bs}
            
            WORKSPACE MAP:
            ${G||"[Empty Workspace]"}

            USER REQUEST: "${n}"
            ${p?`
            EXTENSION RUNTIME SIGNAL:
            - Running inside Chrome extension with browser automation available.
            - Prioritize browser-intent routing for commands like:
              "scroll up/down/top/bottom", "click ...", "type ...", "go back/forward", "refresh", "take screenshot".
            - Apply recovery-first interpretation for minor typos or wording variance in those commands.
            - If user says "read agents.md" (or close variant), treat it as a mode switch: load AGENTS guidance first.
            - If screenshot intent is present, prefer tool "take_screenshot".
            - If direct page-control intent is present, prefer tool "execute_natural_command".
            `:""}
            
            MISSION:
            1. Identify relevant files from the map above.
            2. Determine the best "Gear Mode" and specific Model for this task.
            3. Prefer robust executable routing over parser-style rejection language.

            GEAR MODES:
            - 'reasoning': For deep analysis, architecture, complex logic, or math. (Prefer DeepSeek R1)
            - 'coding': For writing code, refactoring, or software engineering. (Prefer DeepSeek V3 or Gemini Pro)
            - 'search': For current events, docs lookup, or external facts. (Prefer Gemini Flash or DeepSeek V3)
            - 'low-latency': For simple greetings, chit-chat, or quick status checks. (Prefer Llama 8B or Gemini Flash)

            MODEL RECOMMENDATIONS:
            - Default baseline: Provider 'novita', Model 'deepseek/deepseek-v3.2'
            - If task requires complex reasoning/thinking: Provider 'novita', Model 'deepseek/deepseek-r1-turbo'
            - If task is standard coding: Provider 'novita', Model 'deepseek/deepseek-v3.2'
            - If task is simple/fast: Provider 'novita', Model 'meta-llama/llama-3.1-8b-instruct'
            - Use Provider 'gemini' ONLY when explicitly needed (for example explicit Gemini request, very large multimodal context, or image-heavy task).
            
            Return ONLY a JSON object: 
            { 
              "relevantFiles": ["path/to/file"], 
              "confidence": 0.0 to 1.0, 
              "suggestedGear": "coding|reasoning|search|low-latency", 
              "suggestedProvider": "gemini|novita",
              "suggestedModel": "model-id",
              "reason": "string" 
            }
        `;try{const D=new xr({apiKey:"AIzaSyBmcf88Pcq9Z8Mb_dyL9HNOFmDcKWkgSNM",vertexai:!1});let U="";c.startsWith("gemini")?U=(await D.models.generateContent({model:c,contents:C,config:{responseMimeType:"application/json"}})).text||"{}":U=await hr(C,c);const R=this.safeParse(U);if(R.status==="error")return R;const h=R.data,T=h.relevantFiles||[],E=h.confidence||.5;Nr.log("cortex","ContextService","Analyzed workspace intent.",{confidence:E,filesIdentified:T.length,suggestedGear:h.suggestedGear,suggestedModel:h.suggestedModel},Date.now()-f);let L=`<SystemContext>
### DYNAMIC WORKSPACE CONTEXT
`;if(T.length>0)for(const W of T){const le=X.getFileContent(W);L+=`
FILE: ${W}
CONTENT:
${le||"[Binary or Missing]"}
`}else L+=`No specific file context needed for this request.
`;return L+=`</SystemContext>
`,{status:T.length>0?"success":"partial",timestamp:Date.now(),data:{relevantApplets:T,summaryOfPastDecisions:"Project utilizes dynamic VFS linking.",systemPromptAddon:L,confidence:E,suggestedGear:h.suggestedGear,suggestedProvider:h.suggestedProvider,suggestedModel:h.suggestedModel,reason:h.reason}}}catch(D){return console.error("Cortex Resolution Error:",D),{status:"error",timestamp:Date.now(),error:{code:"CORTEX_RUNTIME_ERROR",message:D.message||"Critical failure during context resolution.",source:"ContextService",retryable:!0}}}}safeParse(n){const o=Date.now();try{const c=n.replace(/```json|```/g,"").trim(),i=this.hardenJson(c);return{status:"success",data:JSON.parse(i),timestamp:o}}catch(c){return{status:"error",timestamp:o,error:{code:"PARSE_ERROR",message:`Malformed Cortex response: ${c.message}`,source:"ContextService",retryable:!0,metadata:{raw:n}}}}}hardenJson(n){return n.replace(/([{,]\s*)([a-zA-Z0-9_]+)\s*:/g,'$1"$2":').replace(/'/g,'"').replace(/,\s*([}\]])/g,"$1")}}const As=new en,Ts=[{id:"deepseek/deepseek-v3.2",name:"DeepSeek v3.2 (Recommended Router)",icon:Xt},{id:"deepseek/deepseek-r1-turbo",name:"DeepSeek R1 Turbo (Reasoning)",icon:Xt},{id:"gemini-3-flash-preview",name:"Gemini 3 Flash",icon:Fs},{id:"meta-llama/llama-3.3-70b-instruct",name:"Llama 3.3 70B (Smart)",icon:Us},{id:"meta-llama/llama-3.1-8b-instruct",name:"Llama 3.1 8B (Fast)",icon:Gs}],tn=r=>{const n=String(r||"").trim(),o=Ts.find(f=>f.id===n);if(o)return o;const c=n||Ts[0].id;let i=Xt;return c.includes("gemini")?i=Fs:c.includes("llama")&&(i=Us),{id:c,name:c,icon:i}},$s=[{id:"user",label:"Prompt",color:"#0f766e"},{id:"router",label:"Cortex Router",color:"#1d4ed8"},{id:"tools",label:"Tools",color:"#7c3aed"},{id:"context",label:"Context Sync",color:"#0f766e"},{id:"output",label:"Output",color:"#b45309"}],Ne={user:160,router:400,tools:640,context:880,output:1120},ae=(r,n=52)=>{const o=String(r||"").replace(/\s+/g," ").trim();return o.length<=n?o||"No details":`${o.slice(0,Math.max(0,n-3))}...`},sn=r=>{if(r==null)return"No result";if(typeof r=="string")return ae(r);if(typeof r=="number"||typeof r=="boolean")return String(r);if(typeof r=="object"){const n=r;if(typeof n.status=="string")return ae(n.status);if(typeof n.message=="string")return ae(n.message);if(typeof n.error=="string")return`Error: ${ae(n.error,44)}`;const o=Object.keys(n).slice(0,4);return o.length?`Fields: ${o.join(", ")}`:"Object result"}return"Result"},rn=(r,n,o,c)=>{const i=r.slice(-10),f=[];let m=0;for(const p of i){if(p.role==="user"){f.push({id:`msg-${p.id}-user-${m}`,lane:"user",kind:"user",label:"User Prompt",detail:ae(p.content,66)}),m+=1;continue}if(p.role==="model"){if(f.push({id:`msg-${p.id}-model-${m}`,lane:"router",kind:"model",label:"Model Response",detail:ae(p.content,66)}),m+=1,Array.isArray(p.toolCalls))for(const z of p.toolCalls.slice(0,3))f.push({id:`msg-${p.id}-tool-call-${m}`,lane:"tools",kind:"tool_call",label:`Tool Call: ${ae(String(z.name||"unknown"),28)}`,detail:ae(JSON.stringify(z.args||{}),66)}),m+=1;if(Array.isArray(p.toolResults))for(const z of p.toolResults.slice(0,3))f.push({id:`msg-${p.id}-tool-result-${m}`,lane:"tools",kind:"tool_result",label:`Tool Result: ${ae(String(z.name||"unknown"),26)}`,detail:sn(z.result)}),m+=1}}return n.length>0&&f.push({id:`ctx-sync-${n.length}-${r.length}`,lane:"context",kind:"context_sync",label:`Context Sync (${n.length} file${n.length===1?"":"s"})`,detail:ae(n.slice(0,4).map(p=>p.split("/").pop()||p).join(" , "),64)}),o?f.push({id:`loop-active-${r.length}`,lane:"router",kind:"loop",label:"Loop Active",detail:ae(c||"Cortex is iterating and routing decisions.",66)}):c&&f.push({id:`status-${r.length}`,lane:"output",kind:"status",label:"Latest Status",detail:ae(c,66)}),f.length||f.push({id:"idle-seed",lane:"router",kind:"status",label:"Idle",detail:"Waiting for the next prompt"}),f.slice(-18)},Rs={user:{fill:"#e6fffb",border:"#14b8a6",text:"#0f766e"},model:{fill:"#eff6ff",border:"#3b82f6",text:"#1d4ed8"},tool_call:{fill:"#f5f3ff",border:"#8b5cf6",text:"#6d28d9"},tool_result:{fill:"#ede9fe",border:"#7c3aed",text:"#5b21b6"},context_sync:{fill:"#ecfeff",border:"#0ea5e9",text:"#0369a1"},loop:{fill:"#fff7ed",border:"#f97316",text:"#c2410c"},loop_exit:{fill:"#dcfce7",border:"#22c55e",text:"#166534"},status:{fill:"#f8fafc",border:"#64748b",text:"#334155"}},nn=({isLoading:r,isArchiving:n=!1,activeApplets:o,routerModelId:c,activeProfileName:i,onRemoveApplet:f,confidence:m=0,messages:p=[],agentStatus:z=""})=>{const[ie,b]=a.useState(!1),[G,O]=a.useState(!1),[C,D]=a.useState(0),[U,R]=a.useState(null),h=a.useRef(r),T=tn(c),E=T.icon,L=a.useMemo(()=>rn(p,o,r,z),[p,o,r,z]),W=Math.max(540,170+L.length*94),le=U?new Date(U).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"}):"";a.useEffect(()=>{h.current&&!r&&(D(y=>y+1),R(Date.now())),h.current=r},[r]),a.useEffect(()=>{if(!G)return;const y=$=>{$.key==="Escape"&&O(!1)};return window.addEventListener("keydown",y),()=>window.removeEventListener("keydown",y)},[G]);const he=a.useMemo(()=>{if(!U||r)return L;const y={id:`loop-exit-${U}`,lane:"output",kind:"loop_exit",label:"Loop Exit",detail:`Cycle ${Math.max(1,C)} finished at ${le}`};return[...L,y].slice(-20)},[L,r,U,C,le]),Fe=()=>e.jsxs("svg",{viewBox:`0 0 1280 ${W}`,className:"w-full h-full min-h-[420px]",role:"img","aria-label":"Cortex execution flow map",children:[e.jsxs("defs",{children:[e.jsx("marker",{id:"cortexFlowArrow",markerWidth:"10",markerHeight:"8",refX:"9",refY:"4",orient:"auto",children:e.jsx("path",{d:"M0,0 L10,4 L0,8 z",fill:"rgba(30, 64, 175, 0.78)"})}),e.jsxs("linearGradient",{id:"cortexFlowBackground",x1:"0",y1:"0",x2:"1",y2:"1",children:[e.jsx("stop",{offset:"0%",stopColor:"rgba(59,130,246,0.05)"}),e.jsx("stop",{offset:"100%",stopColor:"rgba(14,165,233,0.03)"})]})]}),e.jsx("rect",{x:"0",y:"0",width:"1280",height:W,fill:"url(#cortexFlowBackground)"}),$s.map(y=>{const $=Ne[y.id];return e.jsxs("g",{children:[e.jsx("line",{x1:$,y1:76,x2:$,y2:W-20,stroke:"rgba(148, 163, 184, 0.32)",strokeWidth:1.25,strokeDasharray:"6 7"}),e.jsx("rect",{x:$-90,y:20,width:180,height:30,rx:15,fill:"rgba(255,255,255,0.85)",stroke:y.color,strokeWidth:1.2}),e.jsx("text",{x:$,y:39,fill:y.color,textAnchor:"middle",fontSize:12,fontWeight:700,style:{letterSpacing:"0.04em"},children:y.label})]},y.id)}),he.slice(0,-1).map((y,$)=>{const B=he[$+1];if(!B)return null;const _=Ne[y.lane],F=102+$*94,J=Ne[B.lane],be=102+($+1)*94,Z=J-_,re=Math.abs(Z)<10?140:Math.max(120,Math.abs(Z)*.42),se=_+(Z>=0?re:-re),Nt=J-(Z>=0?re:-re),it=`M ${_} ${F} C ${se} ${F+18}, ${Nt} ${be-18}, ${J} ${be}`,Ue=y.kind==="loop"||B.kind==="loop";return e.jsx("path",{d:it,fill:"none",stroke:Ue?"rgba(249,115,22,0.88)":"rgba(37,99,235,0.72)",strokeWidth:Ue?2.8:2.2,strokeDasharray:Ue?"7 7":void 0,markerEnd:"url(#cortexFlowArrow)",className:Ue?"bilge-flow-link":""},`${y.id}->${B.id}`)}),he.map((y,$)=>{const B=Ne[y.lane],_=102+$*94,F=Rs[y.kind];return e.jsxs("g",{transform:`translate(${B-90}, ${_-31})`,children:[e.jsx("rect",{width:180,height:62,rx:14,fill:F.fill,stroke:F.border,strokeWidth:1.6}),e.jsx("circle",{cx:13,cy:31,r:4,fill:F.border}),e.jsx("text",{x:24,y:25,fill:F.text,fontSize:12,fontWeight:700,children:ae(y.label,24)}),e.jsx("text",{x:24,y:43,fill:"rgba(15, 23, 42, 0.72)",fontSize:10.2,fontWeight:500,children:ae(y.detail||"",32)})]},y.id)})]});if(!ie)return e.jsxs("button",{onClick:()=>b(!0),className:`
                absolute top-20 right-6 z-20 p-2 rounded-full shadow-lg transition-all duration-300 group
                ${r?"bg-accent/10 text-accent animate-pulse border-accent/50":n?"bg-indigo-500/10 text-indigo-500 border-indigo-500/30":"bg-surface/80 hover:bg-white text-secondary hover:text-primary border-border/50"}
                border backdrop-blur-md
            `,title:"Cortex Watch: Click to view activity",children:[r?e.jsx(Cs,{size:20}):n?e.jsx(jt,{size:20,className:"animate-bounce"}):e.jsx(Ms,{size:20}),o.length>0&&e.jsx("div",{className:"absolute -top-1 -right-1 w-3 h-3 bg-green-500 rounded-full border-2 border-white dark:border-[#1C1C1E]"})]});const ge=e.jsx("div",{className:"absolute top-20 right-6 z-20 animate-fade-in",children:e.jsxs("div",{className:`
            bg-white/95 dark:bg-[#1C1C1E]/95 backdrop-blur-xl border rounded-2xl shadow-2xl p-4 w-72 transition-all duration-300
            ${r?"border-accent shadow-[0_0_30px_rgba(0,113,227,0.15)]":n?"border-indigo-500/50 shadow-[0_0_30px_rgba(99,102,241,0.15)]":"border-border/50"}
        `,children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("span",{className:"text-[10px] font-bold uppercase tracking-wider text-secondary flex items-center gap-2",children:[n?e.jsx(jt,{size:12,className:"text-indigo-500"}):e.jsx(Ms,{size:12}),n?"Neural Sync Active":"Cortex Activity"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>O(!0),className:"p-1 rounded-md text-secondary hover:text-primary hover:bg-black/5 dark:hover:bg-white/10 transition-colors",title:"Open full-screen flow map","aria-label":"Open full-screen flow map",children:e.jsx(_r,{size:13})}),e.jsx("button",{onClick:()=>b(!1),className:"text-secondary hover:text-primary transition-colors",children:e.jsx(kt,{size:14})})]})]}),e.jsx("div",{className:"flex items-center justify-between mb-3 bg-surface/50 p-2 rounded-lg border border-border/50",children:e.jsxs("div",{className:"flex items-center gap-3 w-full min-w-0",children:[e.jsx("div",{className:`p-1.5 rounded-md ${r?"bg-accent/10 text-accent animate-pulse":"bg-white dark:bg-white/5 text-primary shadow-sm"}`,children:e.jsx(E,{size:14})}),e.jsxs("div",{className:"flex flex-col items-start overflow-hidden",children:[e.jsx("span",{className:"text-[9px] font-bold text-secondary",children:"Cortex Router (from active combo)"}),e.jsx("span",{className:"text-[11px] font-medium text-primary truncate w-full text-left",children:T.name}),i&&e.jsxs("span",{className:"text-[9px] text-secondary/80 truncate w-full text-left",children:["Profile: ",i]})]})]})}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between text-[10px] text-secondary",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(gr,{size:12,className:"text-green-600"}),e.jsx("span",{className:"font-mono",children:"main"})]}),o.length>0?e.jsxs("div",{className:"flex items-center gap-1.5 text-accent font-bold bg-accent/5 px-2 py-0.5 rounded-full",children:[e.jsx(br,{size:10})," ",Math.round(m*100),"% Confidence"]}):null]}),e.jsx("div",{className:"min-h-[60px] max-h-[150px] overflow-y-auto pr-1 scrollbar-thin",children:n?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full py-4 space-y-2",children:[e.jsx(qe,{size:24,className:"text-indigo-500 animate-spin"}),e.jsx("span",{className:"text-[10px] text-indigo-600 font-bold uppercase tracking-widest animate-pulse",children:"Filing Technical Discovery"})]}):o.length>0?e.jsx("div",{className:"space-y-1.5",children:o.map((y,$)=>e.jsxs("div",{className:"flex items-center justify-between bg-surface px-2.5 py-1.5 rounded-md border border-border/50 animate-fade-in group/item",style:{animationDelay:`${$*.05}s`},children:[e.jsxs("div",{className:"flex items-center gap-2 overflow-hidden",children:[e.jsx(Cr,{size:12,className:"text-secondary shrink-0"}),e.jsx("span",{className:"text-[10px] font-mono text-primary truncate",title:y,children:y.split("/").pop()})]}),e.jsx("button",{onClick:()=>f==null?void 0:f(y),className:"text-secondary opacity-0 group-hover/item:opacity-100 hover:text-rose-500 transition-all p-0.5","aria-label":`Remove ${y}`,children:e.jsx(kt,{size:10})})]},$))}):e.jsxs("div",{className:"h-full flex flex-col items-center justify-center text-center py-4 border-2 border-dashed border-border/50 rounded-lg",children:[e.jsx(Cs,{size:16,className:"text-secondary/30 mb-2"}),e.jsx("span",{className:"text-[10px] text-secondary italic",children:r?"Scanning filesystem...":"Watching for intent..."})]})})]}),e.jsxs("div",{className:"mt-3 rounded-xl border border-border/50 bg-surface/40 p-2.5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"text-[9px] font-bold uppercase tracking-wider text-secondary flex items-center gap-1.5",children:[e.jsx(Wr,{size:11,className:"text-indigo-500"}),"Flow Execution"]}),e.jsx("button",{type:"button",onClick:()=>O(!0),className:"text-[9px] font-bold uppercase tracking-wider text-indigo-600 hover:text-indigo-700 transition-colors",children:"Fullscreen"})]}),e.jsx("div",{className:"h-20 rounded-lg border border-border/50 bg-white/80 dark:bg-black/20 overflow-hidden",children:e.jsxs("svg",{viewBox:"0 0 1280 200",className:"w-full h-full",children:[$s.map(y=>e.jsx("line",{x1:Ne[y.id],y1:20,x2:Ne[y.id],y2:180,stroke:"rgba(148, 163, 184, 0.28)",strokeWidth:1,strokeDasharray:"4 5"},y.id)),he.slice(0,-1).map((y,$)=>{const B=he[$+1];if(!B)return null;const _=Ne[y.lane],F=Ne[B.lane],J=30+$*22,be=30+($+1)*22,Z=F-_,re=Math.abs(Z)<10?100:Math.max(70,Math.abs(Z)*.4),se=`M ${_} ${J} C ${_+(Z>=0?re:-re)} ${J}, ${F-(Z>=0?re:-re)} ${be}, ${F} ${be}`;return e.jsx("path",{d:se,fill:"none",stroke:y.kind==="loop"||B.kind==="loop"?"rgba(249,115,22,0.9)":"rgba(59,130,246,0.72)",strokeWidth:y.kind==="loop"||B.kind==="loop"?2.2:1.7,strokeDasharray:y.kind==="loop"||B.kind==="loop"?"5 5":void 0,className:y.kind==="loop"||B.kind==="loop"?"bilge-flow-link":""},`${y.id}-${B.id}-mini`)}),he.map((y,$)=>{const B=Ne[y.lane],_=30+$*22,F=Rs[y.kind];return e.jsx("circle",{cx:B,cy:_,r:4.4,fill:F.border,stroke:"rgba(255,255,255,0.85)",strokeWidth:1},`${y.id}-mini`)})]})}),e.jsxs("div",{className:"mt-2 flex items-center justify-between text-[9px] text-secondary/80",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Pr,{size:10})," Back-and-forth map"]}),e.jsxs("span",{className:"font-mono",children:[he.length," nodes"]})]})]}),e.jsxs("div",{className:"mt-3 pt-2 border-t border-border/50 flex justify-between items-center text-[9px] text-secondary/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(yr,{size:8})," VFS LINKED"]}),o.length>0&&e.jsxs("span",{className:"bg-accent/10 text-accent px-1.5 py-0.5 rounded-full font-bold",children:[o.length," FILES ACTIVE"]})]}),e.jsx("span",{className:`w-1.5 h-1.5 rounded-full ${r?"bg-accent animate-pulse":"bg-green-500"}`})]})]})});return e.jsxs(e.Fragment,{children:[G?e.jsx("div",{className:"fixed inset-0 z-[90] bg-black/55 backdrop-blur-xl p-3 sm:p-6 animate-fade-in",children:e.jsxs("div",{className:"w-full h-full rounded-3xl border border-border/60 bg-white/95 dark:bg-[#0F172A]/95 shadow-2xl overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"px-4 sm:px-6 py-3.5 border-b border-border/50 flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"text-[11px] font-black uppercase tracking-[0.2em] text-secondary flex items-center gap-2",children:[e.jsx(zr,{size:12,className:r?"text-orange-500 animate-pulse":"text-green-600"}),"Cortex Activity Flow"]}),e.jsx("div",{className:"text-xs text-primary/90 mt-1 truncate",children:r?"Loop running: watching back-and-forth execution.":U?`Loop exited at ${le} (cycle ${Math.max(1,C)}).`:"Ready for the next execution cycle."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"px-2 py-1 rounded-full border border-border/50 text-[10px] font-bold uppercase tracking-widest text-secondary bg-surface/60 dark:bg-white/5",children:r?"Loop Active":"Loop Idle"}),e.jsx("button",{type:"button",onClick:()=>O(!1),className:"p-2 rounded-lg border border-border/60 text-secondary hover:text-primary hover:bg-black/5 dark:hover:bg-white/10 transition-colors",title:"Close flow map","aria-label":"Close flow map",children:e.jsx(Hr,{size:16})})]})]}),e.jsx("div",{className:"flex-1 overflow-auto p-3 sm:p-5 bg-gradient-to-br from-sky-100/45 via-transparent to-emerald-100/35 dark:from-indigo-900/25 dark:to-cyan-900/20",children:e.jsx("div",{className:"min-w-[1180px] rounded-2xl border border-border/50 bg-white/75 dark:bg-black/25 shadow-inner p-3 sm:p-4",children:Fe()})})]})}):null,ge]})},on=a.memo(({message:r,isStreaming:n=!1,agentStatus:o="",onSetArtifact:c})=>{const i=r.role==="user",f=r.role==="system",{thinking:m,content:p}=Ir(r.content),z=!i&&!f&&n&&!m&&!p,[ie,b]=a.useState({}),G=Number.isFinite(Number(r.timestamp))?new Date(r.timestamp).toLocaleTimeString([],{hour:"numeric",minute:"2-digit"}):"",O=r.toolCalls||[],C=O.length>0,D=a.useMemo(()=>O.map((R,h)=>{var Fe,ge;const T=(Fe=r.toolResults)==null?void 0:Fe[h],E=T&&T.name===R.name?T:(ge=r.toolResults)==null?void 0:ge.find(y=>y.name===R.name),L=E==null?void 0:E.result,W=E!==void 0,le=!!(L&&typeof L=="object"&&L.error);return{tc:R,idx:h,result:E,status:W?le?"error":"done":n?"running":"pending"}}),[n,r.toolResults,O]),U=R=>{b(h=>({...h,[R]:!h[R]}))};return f?e.jsx("div",{className:"flex justify-center px-3 sm:px-4 md:px-12 my-2 animate-fade-in",children:e.jsxs("div",{className:"bg-surface/50 border border-border/50 rounded-full px-4 py-1.5 flex items-center gap-2 text-xs font-medium text-secondary",children:[e.jsx(Gr,{size:12,className:"text-accent"}),r.content]})}):e.jsxs("div",{className:`group/message flex flex-col ${i?"items-end":"items-start"} px-1.5 sm:px-3 md:px-10 lg:px-12 animate-fade-in py-2.5`,children:[e.jsxs("div",{className:`mb-1 flex items-center gap-2 text-[10px] sm:text-[11px] font-bold uppercase tracking-wider opacity-70 ${i?"text-secondary mr-1":"text-accent ml-1"}`,children:[e.jsx("span",{children:i?"Neural Input":"Bilge Core"}),G&&e.jsx("span",{className:"normal-case tracking-normal font-medium text-secondary/70 opacity-80 transition-opacity group-hover/message:opacity-100",children:G})]}),e.jsxs("div",{className:`bilge-chat-message max-w-3xl w-full p-4 sm:p-5 md:p-6 rounded-2xl transition-all shadow-sm ${i?"bg-primary/8 dark:bg-white/8 text-primary border border-primary/10":"bg-surface/40 dark:bg-[#1C1C1E]/40 border border-border/50 text-primary"}`,children:[n&&!i&&e.jsxs("div",{className:`flex items-center gap-2 mb-4 text-xs font-bold uppercase tracking-wider transition-all ${o?"text-accent":"text-secondary/50"}`,children:[e.jsxs("div",{className:"relative",children:[e.jsx(qe,{size:14,className:"animate-spin"}),e.jsx("div",{className:"absolute inset-0 bg-accent/20 rounded-full blur-sm animate-pulse"})]}),e.jsx("span",{children:o||"Bilge Core Processingâ€¦"})]}),m&&!i&&e.jsx(Dr,{content:m,isStreaming:n}),z&&e.jsxs("div",{className:"space-y-2 animate-pulse",children:[e.jsx("div",{className:"h-2.5 rounded-full bg-border/70 w-10/12"}),e.jsx("div",{className:"h-2.5 rounded-full bg-border/60 w-8/12"}),e.jsx("div",{className:"h-2.5 rounded-full bg-border/50 w-6/12"})]}),!z&&e.jsxs("div",{className:`prose prose-sm sm:prose-base max-w-none leading-7 text-[15px] prose-pre:max-w-full prose-pre:overflow-x-auto prose-code:break-words ${i?"prose-p:text-primary prose-headings:text-primary prose-strong:text-primary prose-li:text-primary prose-code:text-primary":"prose-p:text-primary"}`,children:[r.attachments&&r.attachments.length>0&&e.jsx("div",{className:"mb-4 flex flex-wrap gap-2",children:r.attachments.map((R,h)=>e.jsx("img",{src:R,alt:"Attachment",className:"h-32 w-auto rounded-lg border border-white/20 shadow-sm"},h))}),e.jsx(Ar,{remarkPlugins:[Tr],components:{code({node:R,className:h,children:T,...E}){const L=/language-(\w+)/.exec(h||""),W=String(T);return L&&W.includes(`
`)?e.jsx("div",{className:"my-4 not-prose",children:e.jsxs("button",{onClick:()=>c==null?void 0:c({content:W.replace(/\n$/,""),language:L[1]}),className:"group w-full flex items-center justify-between bg-white dark:bg-black/20 hover:bg-surface border border-border rounded-2xl p-4 transition-all",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-10 h-10 bg-surface rounded-xl flex items-center justify-center text-secondary group-hover:text-accent",children:e.jsx(wr,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex flex-col items-start text-left",children:[e.jsx("span",{className:"text-sm font-semibold text-primary",children:"Artifact Generated"}),e.jsx("span",{className:"text-[10px] text-secondary font-bold uppercase tracking-widest",children:L[1]})]})]}),e.jsxs("div",{className:"flex items-center gap-1 text-accent text-sm font-bold opacity-0 group-hover:opacity-100 transition-opacity",children:["Mount ",e.jsx(St,{className:"w-4 h-4"})]})]})}):e.jsx("code",{className:`px-1.5 py-0.5 rounded font-mono text-[0.9em] ${i?"bg-white/20":"bg-surface border border-border text-[#E01E5A]"}`,...E,children:T})}},children:p})]}),r.generatedImages&&e.jsx("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 gap-4",children:r.generatedImages.map((R,h)=>e.jsx("img",{src:`data:image/png;base64,${R}`,className:"w-full h-auto rounded-xl border border-black/10 shadow-lg",alt:"Generated"},h))}),C&&e.jsx("div",{className:"mt-4 space-y-2",children:D.map(({tc:R,idx:h,result:T,status:E})=>{const L=!!ie[h],W=E==="running"?"Running":E==="error"?"Error":E==="done"?"Done":"Pending",le=E==="running"?"text-amber-700 bg-amber-100 border-amber-200":E==="error"?"text-rose-700 bg-rose-100 border-rose-200":E==="done"?"text-emerald-700 bg-emerald-100 border-emerald-200":"text-slate-600 bg-slate-100 border-slate-200";return e.jsxs("div",{className:"bg-white border border-slate-200 rounded-xl overflow-hidden font-mono text-xs leading-5 shadow-sm",children:[e.jsxs("button",{type:"button",onClick:()=>U(h),className:`w-full px-3 py-2 flex items-center justify-between text-left transition-colors ${L?"bg-slate-100":"bg-slate-50 hover:bg-slate-100"}`,children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-sky-500 shadow-[0_0_6px_rgba(14,165,233,0.35)]"}),e.jsxs("span",{className:"font-bold text-slate-800 uppercase tracking-tighter truncate",children:["System call: ",R.name]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`text-[10px] uppercase tracking-wider px-1.5 py-0.5 rounded border ${le}`,children:W}),e.jsx(St,{size:14,className:`text-slate-500 transition-transform ${L?"rotate-90":""}`})]})]}),L&&e.jsxs("div",{className:"p-3 space-y-2 border-t border-slate-200 bg-white",children:[e.jsxs("div",{className:"text-slate-700 break-all whitespace-pre-wrap",children:[e.jsx("span",{className:"text-slate-400 mr-2",children:"$"}),R.name,"(",JSON.stringify(R.args),")"]}),T&&e.jsx("div",{className:"text-slate-700 whitespace-pre-wrap break-words bg-slate-50 border border-slate-200 rounded-lg p-2 max-h-[300px] overflow-auto scrollbar-thin",children:typeof T.result=="string"?T.result:JSON.stringify(T.result,null,2)}),!T&&n&&e.jsxs("div",{className:"flex items-center gap-2 text-amber-700 animate-pulse pl-1 text-xs",children:[e.jsx(qe,{size:11,className:"animate-spin"}),e.jsx("span",{children:"Processing..."})]})]})]},h)})})]})]})},(r,n)=>r.message===n.message&&r.isStreaming===n.isStreaming&&r.agentStatus===n.agentStatus),an=a.forwardRef(({onExecute:r,pageFields:n=[],className:o="w-full px-4 py-3 bg-surface border border-border rounded-xl text-primary placeholder:text-secondary/50 focus:outline-none focus:ring-2 focus:ring-accent/50",placeholder:c="Type a command... (e.g., fill email from profile)",isTextarea:i=!1,value:f,onChange:m,onKeyDown:p,disabled:z=!1},ie)=>{const[b,G]=a.useState([]),[O,C]=a.useState(-1),D=a.useRef(null);a.useImperativeHandle(ie,()=>D.current);const U=a.useCallback(h=>{var T;if(typeof((T=window.__bilge_commandAutocomplete)==null?void 0:T.getSuggestions)=="function"){const E=window.__bilge_commandAutocomplete.getSuggestions(h,n);G(E),C(-1)}},[n]);a.useEffect(()=>{U(f)},[f,U]);const R=h=>{var T;if(p&&p(h),!h.defaultPrevented)if(h.key==="ArrowDown")b.length>0&&(h.preventDefault(),C(E=>Math.min(E+1,b.length-1)));else if(h.key==="ArrowUp")b.length>0&&(h.preventDefault(),C(E=>Math.max(E-1,-1)));else if(h.key==="Tab"&&b.length>0){h.preventDefault();const E=O>=0?b[O]:b[0];m(E),G([])}else h.key==="Enter"&&!h.shiftKey?b.length>0&&O>=0?(h.preventDefault(),m(b[O]),G([])):(!i||i&&!h.shiftKey)&&f.trim()&&((T=window.__bilge_commandAutocomplete)==null||T.saveCommand(f)):h.key==="Escape"&&b.length>0&&(h.preventDefault(),G([]),C(-1))};return e.jsxs("div",{className:"relative w-full",children:[i?e.jsx("textarea",{ref:D,value:f,onChange:h=>m(h.target.value),onKeyDown:R,placeholder:c,className:o,disabled:z}):e.jsx("input",{ref:D,value:f,onChange:h=>m(h.target.value),onKeyDown:R,placeholder:c,className:o,disabled:z}),b.length>0&&e.jsx("ul",{className:"absolute top-full left-0 right-0 mt-1 bg-surface border border-border rounded-xl shadow-xl overflow-hidden z-50",children:b.map((h,T)=>e.jsx("li",{onClick:()=>{var E;m(h),G([]),(E=D.current)==null||E.focus()},className:`px-4 py-2 cursor-pointer text-sm ${T===O?"bg-accent/10 text-accent":"text-primary hover:bg-white/5"}`,children:h},h))})]})}),me=()=>Math.random().toString(36).substring(2,15),ln=140,cn="bilge_user_session",_s="bilge_last_chat_session_v1",Is="bilge_archived_chat_sessions_v1",Ke=r=>String(r||"").replace(/\s+/g," ").trim(),Jt=r=>{const n=Ke(r).toLowerCase();return n?/receiving end does not exist/.test(n)||/could not establish connection/.test(n)||/bridge error/.test(n)||/bridge timeout/.test(n)||/connection refused/.test(n)||/err_connection_refused/.test(n)||/no response from content scripts/.test(n)||/content_runtime_unreachable/.test(n):!1},Zt=r=>/^https?:\/\//i.test(String(r||"").trim());function dn(r,n){const o=r.split(","),c=o[0].match(/:(.*?);/);if(!c)return null;const i=c[1],f=atob(o[1]);let m=f.length;const p=new Uint8Array(m);for(;m--;)p[m]=f.charCodeAt(m);return new File([p],n,{type:i})}const Ds=(r,n)=>{const o=Ke(r)||"Unknown runtime error.",c=String(n||"").trim();if(!c||!Zt(c)){const i=c?`Active tab: \`${c}\`.`:"Active tab is unavailable.";return`${o}

${i} Switch to a normal \`http://\` or \`https://\` page, then retry.`}return Jt(o)?`${o}

Runtime bridge is temporarily unreachable. Retry once; if it repeats, run Stack Guardian (\`stack_manage ensure\`) and try again.`:o},un=r=>{const n=String(r||"").toLowerCase().trim();return n?!!(/\b(analy[sz]e|analysis|summar(y|ize)|implementation|implement|architecture|explain|compare|research|refactor|debug|patch|test(?:ing)?|plan|create\s+(?:an?\s+)?(?:html|js|ts|css|json|md|markdown|file)|html\s+file|xterm|terminal|generate\s+(?:an?\s+)?(?:report|summary|file)|write\s+a\s+summary|open\s+it\s+in\s+browser)\b/i.test(n)||/\b\w+\.(html|js|ts|tsx|css|json|md)\b/i.test(n)||n.split(/\s+/).filter(Boolean).length>=18&&/\b(and|then|after|while|about|implementation)\b/i.test(n)):!1},mn=r=>{const n=String(r||"").trim();if(!n)return null;const o=n.toLowerCase();return/\b(read|open|load|follow|apply|use|sync)\s+(the\s+)?(agents|agnets|agent)(?:\.?\s*md)?\b/i.test(o)||un(o)?null:/\b(screenshot|screen\s*shot|capture\s*(the\s*)?(screen|page)|take\s*(a\s*)?screenshot)\b/i.test(o)?{tool:"take_screenshot",command:"take a screenshot",reason:"Detected screenshot intent."}:/\b(scroll\s*up|scroll\s*down|scroll\s*(to\s*)?(the\s*)?(top|bottom|beginning|start|end)|page\s*up|page\s*down)\b/i.test(o)||/\b(click|tap|press|select|type|enter|input|fill(?:\s+in)?|set|go\s*back|go\s*forward|navigate|refresh|reload|wait|pause|sleep)\b/i.test(o)||/\bwrite\s+.+\s+(?:into|in|to)\b/i.test(o)?{tool:"execute_natural_command",command:n,reason:"Detected direct browser-control intent."}:null},pn=r=>{const n=String(r||"").trim();if(!n)return null;const o=n.toLowerCase();return/^(?:please\s+)?(redeploy|re-deploy|rebuild)\s+(?:the\s+)?bilge(?:\s+agent)?(?:\s+(?:now|pls|please))?[.!?]*$/i.test(o)?{tool:"rebuild_bilge_agent",args:{confirm:!0},reason:"Detected Bilge Agent redeploy shortcut."}:null},fn=r=>{var o;for(let c=r.length-1;c>=0;c-=1){const i=r[c];if(!i||i.role!=="user")continue;const f=String(i.content||"").replace(/\s+/g," ").trim();if(f)return f.slice(0,72)}return(String(((o=r[0])==null?void 0:o.content)||"").replace(/\s+/g," ").trim()||"New Chat").slice(0,72)},xn=r=>{var n;if(!Array.isArray(r)||r.length===0)return"";for(let o=r.length-1;o>=0;o-=1){const c=r[o];if(Array.isArray(c==null?void 0:c.toolCalls))for(let i=c.toolCalls.length-1;i>=0;i-=1){const f=c.toolCalls[i];if(!(!f||typeof f!="object")){if(f.name==="execute_natural_command"){const m=String(((n=f.args)==null?void 0:n.command)||"").trim();if(m)return m}if(f.name==="take_screenshot")return"take a screenshot"}}}return""},Hs=r=>r?`${_s}:${r}`:_s,Ws=r=>r?`${Is}:${r}`:Is,Ys=()=>{try{const r=localStorage.getItem(cn);if(!r)return"";const n=JSON.parse(r);return typeof(n==null?void 0:n.id)=="string"?n.id:""}catch{return""}},hn=()=>{try{const r=Ys(),n=Hs(r||void 0);return String(localStorage.getItem(n)||"").trim()}catch{return""}},qt=(r,n)=>{if(!(!r||!n))try{localStorage.setItem(Hs(r),n)}catch{}},Ls=r=>{try{const n=localStorage.getItem(Ws(r||void 0));if(!n)return[];const o=JSON.parse(n);return Array.isArray(o)?o.map(c=>String(c||"").trim()).filter(Boolean).slice(0,2e3):[]}catch{return[]}},gn=(r,n)=>{if(r)try{localStorage.setItem(Ws(r),JSON.stringify(n))}catch{}},bn=r=>String(r||"").replace(/\s+/g," ").trim(),yn=r=>{const n=Array.isArray(r.messages)?r.messages:[];for(const o of n){if(!o)continue;const c=bn(String(o.content||""));if(c)return c.length>120?`${c.slice(0,117)}...`:c}return"No messages yet"},Os=r=>{if(!Number.isFinite(r))return"";const n=Date.now()-r;if(n<0)return"Now";const o=60*1e3,c=60*o,i=24*c;return n<o?"Just now":n<c?`${Math.floor(n/o)}m ago`:n<i?`${Math.floor(n/c)}h ago`:n<i*2?"Yesterday":n<i*7?`${Math.floor(n/i)}d ago`:new Date(r).toLocaleDateString([],{month:"short",day:"numeric"})},wn=r=>{if(!Number.isFinite(r))return"Older";const n=new Date,o=new Date(n.getFullYear(),n.getMonth(),n.getDate()).getTime(),c=o-1440*60*1e3,i=o-10080*60*1e3;return r>=o?"Today":r>=c?"Yesterday":r>=i?"This Week":"Older"},Vt={ok:!1,total:0,byIntent:{},recent:[]},Ps=r=>{const n=r!=null&&r.byIntent&&typeof r.byIntent=="object"?r.byIntent:{},o={};Object.entries(n).forEach(([i,f])=>{const m=String(i||"").trim().toLowerCase();if(!m)return;const p=Number(f||0);!Number.isFinite(p)||p<=0||(o[m]=Math.max(0,Math.floor(p)))});const c=Array.isArray(r==null?void 0:r.recent)?r.recent.map(i=>({intent:String((i==null?void 0:i.intent)||"").trim().toLowerCase(),target:String((i==null?void 0:i.target)||"").trim(),host:String((i==null?void 0:i.host)||"").trim().toLowerCase(),pathPrefix:String((i==null?void 0:i.pathPrefix)||"/").trim()||"/",successCount:Math.max(0,Math.floor(Number((i==null?void 0:i.successCount)||0))),lastUsed:Number((i==null?void 0:i.lastUsed)||0)})).filter(i=>!!i.intent&&Number.isFinite(i.lastUsed)&&i.lastUsed>0).slice(0,12):[];return{ok:!!(r!=null&&r.ok),total:Math.max(0,Math.floor(Number((r==null?void 0:r.total)||c.length||0))),byIntent:o,recent:c,error:r!=null&&r.error?String(r.error):void 0}},zs=r=>String(r||"").replace(/[_-]+/g," ").replace(/\b\w/g,n=>n.toUpperCase())||"Unknown",vn=r=>{const n=String(r.host||"").trim(),o=String(r.pathPrefix||"").trim();return n&&o&&o!=="/"?`${n}${o}`:n||(o&&o!=="/"?o:"Current page")},kn=()=>{const r=new URLSearchParams(window.location.search),n=String(r.get("session")||"").trim();if(n)return{id:n,source:"url"};const o=hn();return o?{id:o,source:"last"}:{id:me(),source:"auto"}},Sn=r=>new Promise((n,o)=>{const c=new FileReader;c.readAsDataURL(r),c.onload=()=>{const f=c.result.split(",")[1];n(f)},c.onerror=i=>o(i)}),jn=[{id:"auto",label:"Auto",detail:"Use the selected model"},{id:"reasoning",label:"Reasoning",detail:"Deep analysis (R1 class)"},{id:"coding",label:"Coding",detail:"Code-first outputs"},{id:"general",label:"General",detail:"Fast default assistant"},{id:"low-latency",label:"Low Latency",detail:"Fast + cheap (8B class)"},{id:"search",label:"Search",detail:"Prefer web grounding"}],Nn=r=>{const n=String(r||"").trim().toLowerCase();return n&&jn.some(o=>o.id===n)?n:"auto"},Cn=r=>{switch(r){case"reasoning":return"Do deep analysis. Validate assumptions. Show your work briefly.";case"coding":return"Prefer code and concrete diffs. Minimize prose.";case"general":return"Be helpful and pragmatic. Keep it concise.";case"low-latency":return"Be fast and concise. Avoid long explorations unless asked.";case"search":return"Prefer current, verifiable facts. Use available web/search tools and cite sources when possible.";case"auto":default:return""}},Dn=()=>{const{user:r}=vr(),{settings:n,updateSettings:o,openSettings:c,runtimeCapabilities:i,runtimeEnvironment:f}=kr(),[m,p]=a.useState([]),[z,ie]=a.useState(()=>kn()),b=z.id,[G,O]=a.useState(""),[C,D]=a.useState(!1),[U,R]=a.useState(!1),[h,T]=a.useState(null),[E,L]=a.useState("none"),[W,le]=a.useState(null),[he,Fe]=a.useState([]),ge=a.useCallback(async()=>{if(!(!i.canUseBrowserAutomation||f!=="extension"))try{const t=await X.getFormFields();t&&t.fields&&Fe(t.fields)}catch(t){console.warn("Failed to fetch page fields for autocomplete:",t)}},[i.canUseBrowserAutomation,f]);a.useEffect(()=>{var t;if(ge(),window.addEventListener("focus",ge),typeof chrome<"u"&&((t=chrome.runtime)!=null&&t.onMessage)){const s=l=>{var d;if(l.type==="FOCUS_COMMAND_INPUT"&&((d=Ge.current)==null||d.focus()),l.type==="ANALYZE_SCREENSHOT"){const{screenshot:x}=l.payload||{};if(x){Ce(x);const w=dn(x,"screenshot.png");w&&$e(w),O("analyze this screenshot"),setTimeout(()=>Ut(),100)}}};return chrome.runtime.onMessage.addListener(s),()=>{window.removeEventListener("focus",ge),chrome.runtime.onMessage.removeListener(s)}}return()=>window.removeEventListener("focus",ge)},[ge]);const[y,$]=a.useState(!1),[B,_]=a.useState(""),[F,J]=a.useState([]),[be,Z]=a.useState(!1),re=i.canUseBrowserAutomation&&!!n.enableDomMode,se=f==="extension",Nt=m.length===0&&f!=="extension",it=a.useMemo(()=>({runtime:f,browserAutomationAvailable:i.canUseBrowserAutomation,domModeEnabled:re}),[f,i.canUseBrowserAutomation,re]),[Ue,Qt]=a.useState(0),[lt,Ks]=a.useState(()=>X.getLocalTools()),[ct,$e]=a.useState(null),[es,Ce]=a.useState(null),ts=a.useRef(null),ss=a.useRef(null),Ct=a.useRef(null),[Et,Mt]=a.useState("novita"),[Ve,At]=a.useState("deepseek/deepseek-r1-turbo"),[Ee,qs]=a.useState("auto"),[Me,Re]=a.useState(!1),[ve,_e]=a.useState(!1),[Tt,rs]=a.useState(""),[dt,ns]=a.useState(!1),[ut,os]=a.useState([]),[Xe,$t]=a.useState(()=>Ls(Ys()||void 0)),[Je,as]=a.useState(!1),[Ie,ce]=a.useState(!1),[Vs,Rt]=a.useState({}),[is,ls]=a.useState(""),[Ze,pe]=a.useState(null),[Qe,mt]=a.useState(Vt),[pt,ft]=a.useState(!1),[_t,cs]=a.useState(!1),et=a.useRef(null),ds=a.useRef(Ee),De=a.useRef(null),ye=n.enableFullExecutionMode||n.executionPolicy==="yolo",[Xs,It]=a.useState(!1),[Js,us]=a.useState(!1),ke=a.useRef(null),Zs=a.useRef(null),Ge=a.useRef(null),Dt=a.useRef(null),Lt=a.useRef(null),Le=a.useRef(null),fe=a.useRef(!0),xt=a.useRef(0),[ht,Qs]=a.useState({canUp:!1,canDown:!1}),Se=a.useCallback(()=>{const t=ke.current;if(!t)return;const s=t.scrollTop,l=Math.max(0,t.scrollHeight-t.clientHeight),d=s>240,x=l-s>240;Qs(w=>w.canUp===d&&w.canDown===x?w:{canUp:d,canDown:x})},[]),Oe=a.useCallback(()=>{const t=ke.current;if(!t)return;const s=Math.max(0,t.scrollHeight-t.scrollTop-t.clientHeight);fe.current=s<=ln},[]),tt=a.useCallback((t="auto")=>{const s=ke.current;if(!s)return;const l=Math.max(0,s.scrollHeight-s.clientHeight);s.scrollTo({top:l,behavior:t}),fe.current=!0},[]),Pe=a.useCallback(()=>{const t=Ct.current;if(t){try{t.abort()}catch{}$(!1)}},[]),Ot=a.useCallback(()=>{Pe(),p([]),J([]),le(null),L("none"),T(null),Z(!1),$e(null),Ce(null),O(""),De.current=null,fe.current=!0,xt.current=0,ie({id:me(),source:"new"});try{window.history.replaceState(null,"",window.location.pathname)}catch{}},[Pe]),st=a.useCallback(async()=>{if(!r)return os([]),[];as(!0);try{const s=[...await Ns.getChatSessions(r.id)].sort((l,d)=>(d.updatedAt||0)-(l.updatedAt||0));return os(s),s}finally{as(!1)}},[r]),gt=a.useCallback(t=>{const s=String(t||"").trim();if(!s||s===b){_e(!1);return}Pe(),p([]),J([]),le(null),L("none"),De.current=null,fe.current=!0,xt.current=0,ie({id:s,source:"url"}),_e(!1),r&&qt(r.id,s);try{const l=new URLSearchParams(window.location.search);l.set("session",s);const d=l.toString();window.history.replaceState(null,"",d?`${window.location.pathname}?${d}`:window.location.pathname)}catch{}},[Pe,b,r]),rt=a.useCallback(()=>{Re(!1),_e(!1),ce(!1)},[]),bt=a.useCallback(()=>{_e(!0),Re(!1),ce(!1),st()},[st]),er=a.useCallback(t=>{const s=String(t||"").trim();s&&$t(l=>{const d=l.includes(s),x=d?l.filter(w=>w!==s):[...l,s];return pe({text:d?"Session restored":"Session archived",tone:"info"}),x})},[]),Ae=a.useMemo(()=>{const t=new Set(Xe);return ut.map(s=>{const l=Number(s.updatedAt||s.createdAt||0),d=Number.isFinite(l)?l:0,x=String(s.title||"").trim()||"Untitled",w=yn(s),g=Array.isArray(s.messages)?s.messages.length:0;return{id:s.id,title:x,preview:w,timestamp:d,relativeAge:Os(d),messageCount:g,archived:t.has(s.id)}}).sort((s,l)=>l.timestamp-s.timestamp)},[Xe,ut]),yt=a.useMemo(()=>{const t=Tt.trim().toLowerCase();return Ae.filter(s=>!dt&&s.archived&&s.id!==b?!1:t?s.title.toLowerCase().includes(t)||s.preview.toLowerCase().includes(t)||s.id.toLowerCase().includes(t):!0)},[Ae,Tt,dt,b]),tr=a.useMemo(()=>{const t={Today:[],Yesterday:[],"This Week":[],Older:[]};return yt.forEach(s=>{t[wn(s.timestamp)].push(s)}),["Today","Yesterday","This Week","Older"].map(s=>({label:s,items:t[s]})).filter(s=>s.items.length>0)},[yt]),Be=a.useMemo(()=>Ae.find(t=>t.id===b)||null,[b,Ae]),ms=a.useMemo(()=>Ae.filter(t=>!t.archived&&t.id!==b).slice(0,3),[b,Ae]),ps=a.useMemo(()=>Object.entries(Qe.byIntent||{}).sort((t,s)=>s[1]-t[1]).slice(0,6),[Qe.byIntent]),Te=a.useMemo(()=>Array.isArray(n.automationProfiles)?n.automationProfiles:[],[n.automationProfiles]),k=a.useMemo(()=>Te.length===0?null:Te.find(t=>t.id===n.activeAutomationProfileId)||Te[0],[Te,n.activeAutomationProfileId]),Pt=a.useMemo(()=>String((k==null?void 0:k.modelId)||n.defaultModelId||"").trim()||"deepseek/deepseek-v3.2",[k==null?void 0:k.modelId,n.defaultModelId]),nt=a.useCallback(t=>{const s=Ae.filter(x=>!x.archived);if(s.length===0)return;const l=s.findIndex(x=>x.id===b),d=l<0?0:l+t;d<0||d>=s.length||gt(s[d].id)},[b,Ae,gt]);a.useEffect(()=>{if(z.source==="last")try{const t=new URLSearchParams(window.location.search);if(t.get("session")===b)return;t.set("session",b);const s=t.toString();window.history.replaceState(null,"",s?`${window.location.pathname}?${s}`:window.location.pathname)}catch{}},[b,z.source]),a.useEffect(()=>{if(!C)return;const t=s=>{s.key==="Escape"&&(s.preventDefault(),Pe())};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[C,Pe]),a.useEffect(()=>{if(!(r!=null&&r.id)){$t([]);return}$t(Ls(r.id))},[r==null?void 0:r.id]),a.useEffect(()=>{r!=null&&r.id&&gn(r.id,Xe)},[Xe,r==null?void 0:r.id]),a.useEffect(()=>{if(!ve)return;const t=window.setTimeout(()=>{var s,l;(s=Lt.current)==null||s.focus(),(l=Lt.current)==null||l.select()},40);return()=>window.clearTimeout(t)},[ve]),a.useEffect(()=>{ve||(rs(""),ns(!1))},[ve]),a.useEffect(()=>{const t=s=>{const l=s.key.toLowerCase(),d=s.metaKey||s.ctrlKey;if(d&&(l==="k"||l==="p")){s.preventDefault(),bt();return}if(d&&s.key==="["){s.preventDefault(),nt(-1);return}if(d&&s.key==="]"){s.preventDefault(),nt(1);return}s.key==="Escape"&&(ve||Me||Ie)&&(s.preventDefault(),rt())};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[rt,Ie,Me,ve,nt,bt]),a.useEffect(()=>{if(!Ze)return;const t=window.setTimeout(()=>pe(null),2200);return()=>window.clearTimeout(t)},[Ze]),a.useEffect(()=>{ds.current=Ee},[Ee]),a.useEffect(()=>{F.length===0&&Z(!1)},[F.length]),a.useEffect(()=>{if(!i.canUseBrowserAutomation||!se||!Me&&!Ie)return;let t=!1;return(async()=>{ft(!0);try{const l=await X.getDomSkillMemorySummary(8);t||mt(Ps(l))}catch(l){t||mt({...Vt,error:String((l==null?void 0:l.message)||l||"Failed to load skill memory")})}finally{t||ft(!1)}})(),()=>{t=!0}},[se,Ie,Me,i.canUseBrowserAutomation]),a.useEffect(()=>{if(!r||!b)return;let t=!1;return(async()=>{const l=await st();if(t)return;const d=l.find(x=>x.id===b);if(!d){if((z.source==="auto"||z.source==="last")&&l.length>0){const x=l[0];De.current=typeof x.createdAt=="number"?x.createdAt:null,ie({id:x.id,source:"last"}),qt(r.id,x.id);try{const w=new URLSearchParams(window.location.search);w.set("session",x.id);const g=w.toString();window.history.replaceState(null,"",g?`${window.location.pathname}?${g}`:window.location.pathname)}catch{}return}De.current=null,p([]);return}De.current=typeof d.createdAt=="number"?d.createdAt:null,p(Array.isArray(d.messages)?d.messages:[]),ds.current==="auto"&&d.modelId&&(At(d.modelId),Mt(d.modelId.includes("gemini")?"gemini":"novita"))})(),()=>{t=!0}},[st,b,z.source,r]),a.useEffect(()=>{if(!k)return;const t=Nn(k.gearMode),s=String(k.modelId||"").trim()||"deepseek/deepseek-r1-turbo",l=k.provider==="gemini"||s.includes("gemini")?"gemini":"novita";Ee!==t&&qs(t),Et!==l&&Mt(l),Ve!==s&&At(s);const d={enableGoogleSearch:!!k.enableGoogleSearch,enableThinking:!!k.enableThinking};Rt(Y=>Y.enableGoogleSearch===d.enableGoogleSearch&&Y.enableThinking===d.enableThinking?Y:d);const x={};n.defaultProvider!==l&&(x.defaultProvider=l),n.defaultModelId!==s&&(x.defaultModelId=s),n.enableThinking!==!!k.enableThinking&&(x.enableThinking=!!k.enableThinking),n.enableGoogleSearch!==!!k.enableGoogleSearch&&(x.enableGoogleSearch=!!k.enableGoogleSearch);const w=k.executionPolicy||"read";n.executionPolicy!==w&&(x.executionPolicy=w);const g=w==="yolo";if(n.enableFullExecutionMode!==g&&(x.enableFullExecutionMode=g),i.canUseBrowserAutomation){const Y=!!k.enableDomMode;n.enableDomMode!==Y&&(x.enableDomMode=Y)}Object.keys(x).length>0&&o(x)},[k,Ee,Ve,Et,i.canUseBrowserAutomation,n.defaultModelId,n.defaultProvider,n.enableDomMode,n.enableFullExecutionMode,n.enableGoogleSearch,n.enableThinking,n.executionPolicy,o]),a.useEffect(()=>()=>{et.current&&window.clearTimeout(et.current)},[]),a.useEffect(()=>{(async()=>{const s=await X.getTools(n.mcpServers||[],{enableInstacart:n.enableInstacart});Ks(s)})()},[n.mcpServers,n.enableInstacart]),a.useEffect(()=>{if(r&&m.length>0&&!C){const t=Date.now(),s=De.current||t;De.current=s,Ns.saveChatSession({id:b,userId:r.id,title:fn(m),messages:m,createdAt:s,updatedAt:t,modelId:Ve}),qt(r.id,b)}},[m,r,b,Ve,C]),a.useEffect(()=>{const t=m[m.length-1];if(!C&&t&&t.role==="model"&&t.id!==h){const s=t.content.split(`
`);let l=!1;const d=[...F];s.forEach(w=>{const g=w.trim();g.startsWith("cmd: /files ")&&g.substring(12).split(",").map(Q=>Q.trim()).filter(Boolean).forEach(Q=>{d.includes(Q)||(d.push(Q),l=!0)})}),l&&(J(d),de("Context Updated")),(t.content.length>300||t.content.includes("```"))&&(T(t.id),R(!0),(async()=>{const g=await Ss.autoOrganizeChat(m);if(g){const Q=`findings/${g.title.replace(/[^a-z0-9]/gi,"_").toLowerCase()}.md`,K=`# ${g.title}

${g.content}

---
*Recorded by Bilge Archivist: ${new Date().toLocaleString()}*`;await X.executeTool("write_file",{path:Q,content:K,isSilent:!0}),us(!0),setTimeout(()=>us(!1),4e3)}R(!1)})())}},[C,m,h]),a.useEffect(()=>{const t=s=>{Dt.current&&!Dt.current.contains(s.target)&&rt()};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[rt]),a.useEffect(()=>(Le.current&&cancelAnimationFrame(Le.current),Le.current=requestAnimationFrame(()=>{const t=ke.current;if(!t){Le.current=null;return}const s=t.scrollHeight;fe.current||C&&m.length>0?tt(C?"auto":"smooth"):Oe(),xt.current=s,Se(),Le.current=null}),()=>{Le.current&&cancelAnimationFrame(Le.current)}),[m,C,tt,Oe,Se]),a.useEffect(()=>{!fe.current||!ke.current||B&&(tt("auto"),Se())},[B,tt,Se]),a.useEffect(()=>{const t=ke.current;if(!t)return;let s=0;const l=()=>{s&&cancelAnimationFrame(s),s=requestAnimationFrame(()=>{Oe(),Se()})};return xt.current=t.scrollHeight,Oe(),Se(),t.addEventListener("scroll",l,{passive:!0}),window.addEventListener("resize",l),()=>{t.removeEventListener("scroll",l),window.removeEventListener("resize",l),s&&cancelAnimationFrame(s)}},[Oe,Se]),a.useEffect(()=>{const t=ke.current;if(!t)return;let s=0,l=0;const d=w=>{var Y;const g=(Y=w.changedTouches)==null?void 0:Y[0];g&&(s=g.clientX,l=g.clientY)},x=w=>{var K;const g=(K=w.changedTouches)==null?void 0:K[0];if(!g)return;const Y=g.clientX-s,Q=g.clientY-l;Math.abs(Y)<90||Math.abs(Q)>70||nt(Y>0?-1:1)};return t.addEventListener("touchstart",d,{passive:!0}),t.addEventListener("touchend",x,{passive:!0}),()=>{t.removeEventListener("touchstart",d),t.removeEventListener("touchend",x)}},[nt]),a.useEffect(()=>{Oe(),Se()},[m.length,C,Oe,Se]),a.useEffect(()=>{var t;(t=Ge.current)==null||t.focus()},[]),a.useEffect(()=>{W&&L("artifact")},[W]);const zt=a.useCallback(t=>{if(!t)return;t.style.height="0px";const s=Math.min(180,Math.max(44,t.scrollHeight));t.style.height=`${s}px`},[]);a.useEffect(()=>{zt(Ge.current)},[G,zt]);const de=t=>{ls(t),et.current&&window.clearTimeout(et.current),et.current=window.setTimeout(()=>ls(""),900)},Ft=a.useCallback(async()=>{if(!(!i.canUseBrowserAutomation||!se)){ft(!0);try{const t=await X.getDomSkillMemorySummary(8),s=Ps(t);mt(s),!s.ok&&s.error&&pe({text:`Skill memory unavailable: ${s.error}`,tone:"error"})}catch(t){const s=String((t==null?void 0:t.message)||t||"Failed to refresh skill memory");pe({text:s,tone:"error"}),mt({...Vt,error:s})}finally{ft(!1)}}},[se,i.canUseBrowserAutomation]),sr=a.useCallback(async()=>{if(!(!i.canUseBrowserAutomation||!se)&&confirm("Clear all learned DOM skills? Bilge will relearn from new actions.")){cs(!0);try{const t=await X.clearDomSkillMemory();if(!(t!=null&&t.ok)){pe({text:`Failed to clear skill memory: ${String((t==null?void 0:t.error)||"Unknown error")}`,tone:"error"});return}const s=Math.max(0,Math.floor(Number((t==null?void 0:t.cleared)||0)));pe({text:s>0?`Cleared ${s} learned skills`:"Skill memory already empty",tone:"info"}),await Ft()}catch(t){pe({text:`Failed to clear skill memory: ${String((t==null?void 0:t.message)||t||"Unknown error")}`,tone:"error"})}finally{cs(!1)}}},[se,Ft,i.canUseBrowserAutomation]),rr=a.useCallback(t=>{const s=Te.find(d=>d.id===t)||Te[0]||null;if(!s)return;const l={activeAutomationProfileId:s.id,defaultProvider:s.provider,defaultModelId:s.modelId,enableThinking:!!s.enableThinking,enableGoogleSearch:!!s.enableGoogleSearch,executionPolicy:s.executionPolicy||"read",enableFullExecutionMode:(s.executionPolicy||"read")==="yolo"};i.canUseBrowserAutomation&&(l.enableDomMode=!!s.enableDomMode),o(l),Re(!1),ce(!1),de(`Profile: ${s.name}`)},[Te,i.canUseBrowserAutomation,o]),nr=a.useCallback(t=>{le(t),L("artifact")},[]),or=async()=>{if(m.length===0)return;const t=m.map(s=>{let d=`[${s.role==="user"?"USER":s.role==="model"?"ASSISTANT":"SYSTEM"}]
${s.content}`;return s.toolCalls&&s.toolCalls.length>0&&(d+=`

TOOL CALLS:`,s.toolCalls.forEach(x=>{d+=`
- ${x.name}(${JSON.stringify(x.args,null,2)})`})),s.toolResults&&s.toolResults.length>0&&(d+=`

TOOL RESULTS:`,s.toolResults.forEach(x=>{const w=typeof x.result=="string"?x.result:JSON.stringify(x.result,null,2);d+=`
- ${x.name}:
${w}`})),d}).join(`

`+"=".repeat(40)+`

`);try{await navigator.clipboard.writeText(t),de("Chat Copied"),pe({text:"Chat copied to clipboard",tone:"info"})}catch(s){console.error("Failed to copy chat:",s);try{const l=document.createElement("textarea");l.value=t,l.style.position="fixed",l.style.opacity="0",document.body.appendChild(l),l.select(),document.execCommand("copy"),document.body.removeChild(l),de("Chat Copied"),pe({text:"Chat copied to clipboard",tone:"info"})}catch{de("Copy failed"),pe({text:"Unable to copy chat",tone:"error"})}}},ar=async t=>{if(!t.target.files)return;const s=Array.from(t.target.files);let l=`FOLDER CONTEXT:
`,d=0;const x=s.slice(0,50);for(const w of x)if(w.name.match(/\.(md|txt|ts|tsx|js|jsx|json|py|html|css|scss|java|c|cpp|h|rs|go|sh)$/i)&&w.size<5e5)try{const g=await w.text();l+=`
--- ${w.webkitRelativePath||w.name} ---
${g}
`,d++}catch{}d>0&&p(w=>[...w,{id:me(),role:"user",content:`[SYSTEM: FOLDER CONTEXT LOADED] Loaded ${d} files.
${l}`,timestamp:Date.now()},{id:me(),role:"model",content:`Folder context received. I have analyzed ${d} files. What would you like to know?`,timestamp:Date.now()}])},fs=async t=>{var d;Mt(t.provider),At(t.model),D(!0),$(!0);const s=me(),l={id:me(),role:"system",content:`**Neural Handover Complete.** Agent using **${t.modelDisplay}** is joining as **${t.role}**.`,timestamp:Date.now()};p(x=>[...x,l,{id:s,role:"model",content:"",timestamp:Date.now()}]);try{const x=await As.resolveIntelligentContext("Prepare a technical summary of the current workspace for a new peer agent.",m,Pt,it),w=x.data||null;w?(J(w.relevantApplets),Z(!1),Qt(w.confidence)):_(((d=x.error)==null?void 0:d.message)||"Cortex context unavailable."),$(!1);let g="Introduce yourself and state your readiness to write code or analyze architecture.";t.role==="MCP Operator"?g="Introduce yourself as the system operator. State your capability to run high-privilege scripts via 'run_script_direct', automate the browser, and manage MCP tools. Offer to test the MCP 'round trip' using 'test_mcp_round_trip'.":t.role==="Stack Guardian"?g="Introduce yourself as Stack Guardian (SRE + network ops). Immediately run stack diagnostics using `stack_manage` with action=`status` target=`agent`, then if unhealthy run `stack_manage` action=`ensure` target=`agent` auto_heal=true ensure_ports=true. Report exactly which services/ports were unhealthy, what you restarted, and final health.":t.role==="Logic Auditor"?g="Introduce yourself as a security and logic specialist. Focus on verifying assumptions, checking for edge cases, and ensuring code quality.":t.role==="UI Engineer"?g="Introduce yourself as a frontend specialist. Focus on UI/UX, CSS, React components, and visual polish.":t.role==="Architect"&&(g="Introduce yourself as a system architect. Focus on high-level structure, scalability, and design patterns.");const Y=`
            You have just been "dropped" into this conversation. 
            PERSONA: You are the **${t.role}** using model **${t.modelDisplay}**. 
	            WORKSPACE CONTEXT: ${(w==null?void 0:w.systemPromptAddon)||"(no context)"}
	            OBJECTIVE: ${g}
	          `,Q=ot=>{p(wt=>wt.map(He=>He.id===s?{...He,content:He.content+ot}:He))},K=[...m,l];t.provider==="novita"?await vs(K,Y,Q,t.model,lt,{onStatus:_}):await ks(K,Y,Q,{modelId:t.model,mcpTools:lt,onStatus:_})}catch(x){console.error("Handover error",x)}finally{D(!1),$(!1)}},ir=t=>{t.preventDefault(),It(!0)},lr=()=>{It(!1)},cr=t=>{t.preventDefault(),It(!1);const s=t.dataTransfer.getData("application/bilge-agent");if(s)try{const l=JSON.parse(s);fs(l)}catch(l){console.error("Drop parse error",l)}},dr=t=>{const s=t.clipboardData.items;for(let l=0;l<s.length;l++)if(s[l].type.indexOf("image")!==-1){const d=s[l].getAsFile();d&&($e(d),Ce(URL.createObjectURL(d)),de("Image Pasted"))}},Ut=async t=>{var hs,gs,bs;if(t&&t.preventDefault(),!G.trim()&&!ct||C)return;const s=G,l=ct;if(s.startsWith("/")){const v=s.split(/\s+/),ee=v[0].toLowerCase(),te=v[1];if(ee==="/add"&&te){const N=[...F];N.includes(te)||(N.push(te),J(N),de(`Added: ${te}`)),O("");return}if(ee==="/drop"&&te){J(N=>N.filter(q=>q!==te)),de(`Dropped: ${te}`),O("");return}if(ee==="/clear"){J([]),de("Context Cleared"),O("");return}}const d=l?null:pn(s);if(d){const v={id:me(),role:"user",content:s,timestamp:Date.now()},ee=me(),te={id:ee,role:"model",content:"",timestamp:Date.now()};if(m.length===0)try{window.history.replaceState(null,"",`?session=${b}`)}catch{}O(""),$e(null),Ce(null),Z(!1),$(!1),D(!0),fe.current=!0,_("Triggering redeploy..."),p(P=>[...P,v,te]);const N=[{name:d.tool,args:d.args}],q=[];try{const P=await X.executeTool(d.tool,d.args);q.push({name:d.tool,result:P});const V=Ke(P==null?void 0:P.error);if(V){p(j=>j.map(u=>u.id===ee?{...u,content:`**Failed:** ${V}

${d.reason}

Tip: set MCP Base URL to \`http://127.0.0.1:8010\` and paste \`STATUS_API_TOKEN\` (Settings â†’ MCP / Tools).`,toolCalls:N,toolResults:q}:u));return}const ue=String(((gs=(hs=P==null?void 0:P.content)==null?void 0:hs[0])==null?void 0:gs.text)||"").trim();if(!ue){p(j=>j.map(u=>u.id===ee?{...u,content:`Redeploy triggered, but no payload was returned.

${d.reason}

Check Stacks: \`https://stacks.caravanflow.com\` â†’ Ops.`,toolCalls:N,toolResults:q}:u));return}let S=null;try{S=JSON.parse(ue)}catch{S=null}const je=S&&typeof S.op_id=="string"?S.op_id:"",H=!!(S&&S.ok)?"Redeploy started.":"**Failed:** Redeploy tool returned an error.",ze=je?`

op_id: \`${je}\``:"",at=`

Watch logs: \`https://stacks.caravanflow.com/api/ops/${je||"<op_id>"}?tail_lines=200\``;p(j=>j.map(u=>u.id===ee?{...u,content:`${H}${ze}${at}

${d.reason}`,toolCalls:N,toolResults:q}:u))}catch(P){const V=String((P==null?void 0:P.message)||"Redeploy failed");p(ue=>ue.map(S=>S.id===ee?{...S,content:`**Failed:** ${V}

${d.reason}`,toolCalls:N}:S))}finally{D(!1),_("")}return}const x=i.canUseBrowserAutomation&&n.enableDomMode&&/^(try\s+again|retry|again)$/i.test(s.trim())?xn(m):"",w=i.canUseBrowserAutomation&&n.enableDomMode?mn(x||s):null,g=w&&x?{...w,command:x,reason:`Retrying last browser-control command: "${x}".`}:w;if(g&&!l){const v={id:me(),role:"user",content:s,timestamp:Date.now()},ee=me(),te={id:ee,role:"model",content:"",timestamp:Date.now()};if(m.length===0)try{window.history.replaceState(null,"",`?session=${b}`)}catch{}O(""),$e(null),Ce(null),Z(!1),$(!1),D(!0),fe.current=!0,_(`Executing ${g.tool}...`),p(N=>[...N,v,te]);try{const N=g.tool==="take_screenshot"?{}:{command:g.command},q=[],P=[],V=[],ue=(I,A,Bt)=>{q.push({name:I,args:A}),P.push({name:I,result:Bt})};_("Checking browser runtime..."),q.push({name:"get_browser_context",args:{}});let S=await X.executeTool("get_browser_context",{});P.push({name:"get_browser_context",result:S});const je=Ke((S==null?void 0:S.error)||(S==null?void 0:S._recoverReason));if((je||!Zt(S==null?void 0:S.url))&&Jt(je)){const I={action:"ensure",target:"agent",auto_heal:!0,ensure_ports:!0,max_cycles:2};_("Browser runtime unreachable. Running Stack Guardian...");const A=await X.executeTool("stack_manage",I);ue("stack_manage",I,A),A!=null&&A.error?V.push(`Recovery failed: ${String(A.error)}`):(A==null?void 0:A.healthy)===!0||(A==null?void 0:A.recovered)===!0?V.push("Stack Guardian restored runtime health."):V.push("Stack Guardian completed, but runtime health is still uncertain."),q.push({name:"get_browser_context",args:{}}),S=await X.executeTool("get_browser_context",{}),P.push({name:"get_browser_context",result:S})}const vt=Ke((S==null?void 0:S.error)||(S==null?void 0:S._recoverReason));if(vt||!Zt(S==null?void 0:S.url)){const I=Ds(vt||"Active tab is not automatable.",S==null?void 0:S.url),A=V.length>0?`

${V.join(" ")}`:"";p(Bt=>Bt.map(Ht=>Ht.id===ee?{...Ht,content:`**Failed:** ${I}${A}

${g.reason}`,toolCalls:q,toolResults:P}:Ht));return}_(`Executing ${g.tool}...`);let H=await X.executeTool(g.tool,N);ue(g.tool,N,H);const ze=Ke(H==null?void 0:H.error);if(ze&&Jt(ze)){const I={action:"ensure",target:"agent",auto_heal:!0,ensure_ports:!0,max_cycles:2};_("Command failed due to runtime connectivity. Healing and retrying...");const A=await X.executeTool("stack_manage",I);ue("stack_manage",I,A),!(A!=null&&A.error)&&((A==null?void 0:A.healthy)===!0||(A==null?void 0:A.recovered)===!0)?(V.push("Recovered runtime and retried command."),_(`Retrying ${g.tool}...`),H=await X.executeTool(g.tool,N),ue(g.tool,N,H)):A!=null&&A.error&&V.push(`Recovery failed: ${String(A.error)}`)}const at=!!(H!=null&&H.error),j=at?Ds(H==null?void 0:H.error,S==null?void 0:S.url):"",u=at?`**Failed:** ${j}`:g.tool==="take_screenshot"?"Captured screenshot from the active tab.":`Executed browser command: \`${g.command}\``,M=V.length>0?`

${V.join(" ")}`:"";p(I=>I.map(A=>A.id!==ee?A:{...A,content:`${u}${M}

${g.reason}`,toolCalls:q,toolResults:P,generatedImages:H!=null&&H._imageData?[String(H._imageData)]:void 0}))}catch(N){const q=String((N==null?void 0:N.message)||"Natural command execution failed");p(P=>P.map(V=>V.id===ee?{...V,content:`**Failed:** ${q}`}:V))}finally{D(!1),_("")}return}Z(!1),O(""),$e(null),Ce(null),D(!0),$(!0),fe.current=!0;const Y=new AbortController;Ct.current=Y;const{signal:Q}=Y,K=me(),ot=l?await Sn(l):null,wt=ot?`data:${l.type};base64,${ot}`:null,He={id:me(),role:"user",content:s,timestamp:Date.now(),attachments:wt?[wt]:void 0},ur={id:K,role:"model",content:"",timestamp:Date.now()};let mr=!1,Gt=!1;const pr=/(?:\/|[a-z0-9_.\-]+\/)+[a-z0-9_.\-]+\.[a-z0-9]+/gi,xs=(s.match(pr)||[]).map(v=>v.replace(/^\.\//,""));m.length===0&&window.history.replaceState(null,"",`?session=${b}`),p(v=>[...v,He,ur]);let We=Ee,xe=Et,oe=Ve,Ye={...Vs};try{let v=null;try{_("Analyzing workspace context (Cortex)...");const j=await As.resolveIntelligentContext(s,m,Pt,it);if(v=j.data||null,!v&&j.status==="error"&&_(((bs=j.error)==null?void 0:bs.message)||"Cortex context unavailable."),v){if(Ee==="auto"&&v.suggestedGear&&v.suggestedGear!=="auto"){const u=v.suggestedGear;We=u,v.suggestedProvider&&v.suggestedModel?(xe=v.suggestedProvider,oe=v.suggestedModel):u==="reasoning"?(xe="novita",oe="deepseek/deepseek-r1-turbo"):u==="coding"?(xe="novita",oe="deepseek/deepseek-v3.2"):u==="search"?(xe="novita",oe="deepseek/deepseek-v3.2",Ye.enableGoogleSearch=!0):u==="low-latency"&&(xe="novita",oe="meta-llama/llama-3.1-8b-instruct"),u==="search"&&Rt(I=>({...I,enableGoogleSearch:!0}));const M=oe.split("/").pop()||oe;de(`Auto: ${u} (${M})`)}if(xs.length>0){for(const u of xs)if(!v.relevantApplets.includes(u)){const M=X.getFileContent(u);M&&(v.relevantApplets.push(u),v.systemPromptAddon+=`
FILE (Explicit): ${u}
CONTENT:
${M}
`)}}J(v.relevantApplets),Z(!1),Qt(v.confidence)}}catch(j){console.warn(j)}if(Q.aborted)throw new DOMException("Aborted","AbortError");$(!1),_("Preparing neural link...");const ee=j=>{j&&(mr=!0),p(u=>u.map(I=>I.id===K?{...I,content:I.content+j}:I))},te=j=>{j&&j.length>0&&(Gt=!0),p(u=>u.map(M=>M.id===K?{...M,generatedImages:[...M.generatedImages||[],...j]}:M))};if(Ee==="auto"&&We==="auto"){const j=s.toLowerCase();let u=null;/(search|find|google|lookup|current events|news|weather|price of|who is)/i.test(s)?u="search":/(fix|refactor|debug|code|function|class|import|const|var|let|typescript|python|react|component|api|endpoint)/i.test(s)?u="coding":/(why|explain|analyze|reason|think|compare|architecture|design pattern|tradeoff)/i.test(s)?u="reasoning":s.length<15&&/(hi|hello|hey|thanks|cool|ok)/i.test(s)&&(u="low-latency"),u&&(We=u,de(`Auto: ${u}`),u==="reasoning"?(xe="novita",oe="deepseek/deepseek-r1-turbo"):u==="coding"?(xe="novita",oe="deepseek/deepseek-v3.2"):u==="search"?(xe="novita",oe="deepseek/deepseek-v3.2",Ye.enableGoogleSearch=!0):u==="low-latency"?(xe="novita",oe="meta-llama/llama-3.1-8b-instruct"):u==="general"&&(xe="novita",oe="deepseek/deepseek-v3.2"),u==="search"&&Rt(M=>({...M,enableGoogleSearch:!0})))}const N=Cn(We),q=We!=="auto"?`

GEAR MODE: ${We.toUpperCase()}
INSTRUCTION: ${N}`:"",P=v!=null&&v.systemPromptAddon?`${v.systemPromptAddon}

USER REQUEST: ${s}${q}`:`${s}${q}`,V=await X.isBridgeConnected();if(Q.aborted)throw new DOMException("Aborted","AbortError");const ue=i.canUseBrowserAutomation?"\n\nSYSTEM STATUS: **Chrome Extension Runtime**. For page interaction, use browser-native tools (`execute_natural_command`, `execute_batch_actions`, `click_element`, `type_text`, `take_screenshot`). Do not output OS-level control commands like `xdotool`.":V?`

SYSTEM STATUS: **Connected to Host (MacOS)**. 'execute_shell_command' runs directly on the user's physical machine. You have full access.`:`

SYSTEM STATUS: **Disconnected from Host**. 'execute_shell_command' runs in a browser-based virtual file system (VFS).`,S=ye?`

FULL POWER MODE ACTIVE: You are in a high-capability environment. You may edit code, run tools, browse web/DOM, and automate workflows end-to-end. Use 'read_file' before changing code. Prefer 'patch' for edits. For browser automation, prefer 'execute_batch_actions' for multi-step flows (forms, wizards). Use 'take_screenshot'/'explore_browser_dom' before acting; use 'click_element'/'type_text' for one-offs and pass heuristic hints (field/name/label/placeholder) when selectors are unstable. You have full JavaScript power via 'execute_javascript' (page context) and 'run_script_direct' (MAIN world) when needed.`:"",je=re?`

DOM MANIPULATION MODE ACTIVE: You may use browser automation capabilities. Prefer 'execute_batch_actions' for multi-step interactions; use 'take_screenshot'/'explore_browser_dom' before clicking/typing.`:"",H=!!(n.enableGoogleSearch||Ye.enableGoogleSearch||ye)?lt:lt.filter(j=>j.name!=="web_search"),ze=i.canUseBrowserAutomation?H.filter(j=>j.name!=="execute_shell_command"):H;if(xe==="novita"?await vs(m,P+ue+S+je,ee,oe,ze,{onImages:te,onToolCall:j=>{p(u=>u.map(M=>M.id===K?{...M,toolCalls:[...M.toolCalls||[],...j]}:M))},onToolResult:(j,u)=>{p(M=>M.map(I=>I.id===K?{...I,toolResults:[...I.toolResults||[],{name:j,result:u}]}:I))},onStatus:_,enableThinking:n.enableThinking||Ye.enableThinking||ye,enableBrowserContext:ye||re,abortSignal:Q}):await ks(m,P+ue+S+je,ee,{modelId:oe,enableGoogleSearch:n.enableGoogleSearch||Ye.enableGoogleSearch||ye,enableThinking:n.enableThinking||Ye.enableThinking||ye,enableFullExecutionMode:n.enableFullExecutionMode||ye,enableAutoGit:n.enableAutoGit||ye,enableBrowserContext:ye||re,onStatus:_,imageData:ot||void 0,imageMimeType:l==null?void 0:l.type,onImages:j=>{j&&j.length>0&&(Gt=!0),p(u=>u.map(M=>M.id===K?{...M,generatedImages:j}:M))},onToolCall:j=>{p(u=>u.map(M=>M.id===K?{...M,toolCalls:[...M.toolCalls||[],...j]}:M))},onToolResult:(j,u)=>{p(M=>M.map(I=>I.id===K?{...I,toolResults:[...I.toolResults||[],{name:j,result:u}]}:I))},mcpTools:ze,abortSignal:Q}),Q.aborted){p(j=>j.map(u=>u.id!==K||(u.generatedImages||[]).length>0||String(u.content||"").trim()?u:{...u,content:"**Interrupted.**"}));return}p(j=>j.map(u=>u.id!==K||(u.generatedImages||[]).length>0||Gt||String(u.content||"").replace(/<\/?think>/gi,"").replace(/<<think>>/gi,"").replace(/<<\/think>>/gi,"").trim()?u:{...u,content:"**No response received.** Try again; if it repeats, check API keys / network."}))}catch(v){if(Q.aborted||(v==null?void 0:v.name)==="AbortError"||String((v==null?void 0:v.name)||"").toLowerCase().includes("abort")){p(te=>te.map(N=>N.id!==K||(N.generatedImages||[]).length>0||String(N.content||"").trim()?N:{...N,content:"**Interrupted.**"})),$(!1);return}console.error("Generation error:",v),pe({text:`Generation failed: ${String((v==null?void 0:v.message)||"Unknown error")}`,tone:"error"}),p(te=>te.map(N=>{if(N.id!==K)return N;const q=String((v==null?void 0:v.message)||"Failed to generate response.").trim(),P=String(N.content||"").trim()?`${N.content.trimEnd()}

`:"";return{...N,content:`${P}**Error**: ${q}`}})),$(!1)}finally{Ct.current=null,D(!1),_("")}};return e.jsxs("div",{className:"flex h-full w-full relative overflow-hidden",onDragOver:ir,onDragLeave:lr,onDrop:cr,onPaste:dr,children:[Xs&&e.jsxs("div",{className:"absolute inset-0 z-50 bg-accent/10 backdrop-blur-sm flex flex-col items-center justify-center border-4 border-dashed border-accent/50 animate-pulse",children:[e.jsx("div",{className:"bg-white dark:bg-black p-8 rounded-full shadow-2xl scale-110",children:e.jsx(Yr,{className:"w-16 h-16 text-accent"})}),e.jsx("p",{className:"mt-6 text-xl font-bold text-accent uppercase tracking-widest",children:"Handover Context to Agent"})]}),e.jsx(nn,{isLoading:y,isArchiving:U,activeApplets:F,routerModelId:Pt,activeProfileName:k==null?void 0:k.name,onRemoveApplet:t=>J(s=>s.filter(l=>l!==t)),confidence:Ue,messages:m,agentStatus:B}),e.jsxs("div",{className:`relative flex flex-col h-full transition-all duration-500 ${E!=="none"?"w-full md:w-1/2":"w-full"}`,children:[e.jsxs("div",{className:"relative z-[120] shrink-0 px-2 sm:px-3 pt-2 sm:pt-3",children:[e.jsxs("div",{className:"mx-auto w-full max-w-3xl mb-1 px-2 py-1.5 flex items-center justify-between gap-2 text-xs",children:[e.jsxs("div",{className:"min-w-0 flex items-center gap-1.5 text-secondary",children:[e.jsx("span",{className:"font-semibold text-primary/80",children:"Builder"}),e.jsx(St,{size:12,className:"opacity-60"}),e.jsx("span",{className:"text-secondary/70",children:"Session:"}),e.jsx("span",{className:"truncate text-primary font-medium",title:(Be==null?void 0:Be.title)||"New chat",children:(Be==null?void 0:Be.title)||"New chat"}),k&&e.jsxs(e.Fragment,{children:[e.jsx(St,{size:12,className:"opacity-40"}),e.jsxs("span",{className:"truncate text-secondary/80",title:k.name,children:["Profile: ",k.name]})]})]}),e.jsxs("button",{type:"button",onClick:bt,className:"shrink-0 inline-flex items-center gap-1 px-2 py-1 rounded-full border border-border/50 bg-surface/60 dark:bg-white/5 text-secondary hover:text-primary hover:bg-black/5 dark:hover:bg-white/5 transition-colors",title:"Switch session",children:["Switch",e.jsx(Yt,{size:12})]})]}),e.jsx("div",{className:"mx-auto w-full max-w-3xl flex justify-center",children:e.jsxs("div",{ref:Dt,className:"relative z-[120] flex w-max max-w-full items-center gap-1 px-1.5 py-1 bg-surface/40 dark:bg-[#1E1F20]/40 backdrop-blur-2xl border border-border/30 rounded-full shadow-sm overflow-visible",children:[e.jsxs("button",{type:"button",onClick:()=>ve?_e(!1):bt(),title:"Sessions","aria-label":"Sessions",className:`relative group flex items-center justify-center w-8 h-8 rounded-full transition-all ${ve?"bg-black/10 dark:bg-white/10 text-primary":"text-secondary hover:bg-black/5 dark:hover:bg-white/5"}`,children:[e.jsx(Es,{size:14}),e.jsx("span",{className:"absolute bottom-full mb-2 left-1/2 -translate-x-1/2 px-2 py-1 bg-black/80 text-white text-[10px] rounded shadow-sm opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-50",children:"Sessions"})]}),ve&&e.jsxs("div",{onMouseDown:t=>t.stopPropagation(),className:`pointer-events-auto absolute top-full mt-2 left-1/2 -translate-x-1/2 z-[220] flex max-h-[min(72vh,680px)] ${se?"w-[min(420px,calc(100vw-1rem))]":"w-[min(560px,calc(100vw-2rem))]"} flex-col overflow-hidden rounded-xl border border-border/50 bg-white/90 p-2 shadow-spotlight backdrop-blur-xl animate-fade-in dark:bg-[#2C2C2E]/90`,children:[e.jsxs("div",{className:"flex items-center justify-between px-1 pb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-[10px] font-bold uppercase tracking-wider text-secondary",children:"Sessions"}),e.jsx("span",{className:"inline-flex items-center px-1.5 py-0.5 rounded-full bg-surface/70 border border-border/50 text-[10px] font-semibold text-secondary",children:yt.length})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",onClick:()=>{Ot(),rt()},className:"px-2 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wider bg-accent text-white hover:bg-accent/90 transition-colors",children:"New"}),e.jsx("button",{type:"button",onClick:()=>void st(),className:"px-2 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wider bg-white/60 dark:bg-black/10 border border-border/60 text-secondary hover:bg-black/5 dark:hover:bg-white/5 transition-colors",children:Je?"â€¦":"Refresh"})]})]}),e.jsxs("div",{onWheel:t=>t.stopPropagation(),className:"min-h-0 flex-1 overflow-y-auto overscroll-contain pr-1 [scrollbar-gutter:stable] [touch-action:pan-y] [-webkit-overflow-scrolling:touch]",children:[e.jsxs("div",{className:"sticky top-0 z-10 space-y-2 border-b border-border/40 bg-white/95 px-1 pb-2 backdrop-blur-xl dark:bg-[#2C2C2E]/95",children:[e.jsxs("div",{className:"pt-1 flex items-center gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx($r,{size:13,className:"absolute left-2.5 top-1/2 -translate-y-1/2 text-secondary/60"}),e.jsx("input",{ref:Lt,value:Tt,onChange:t=>rs(t.target.value),placeholder:"Search sessions...",className:`w-full ${se?"h-9 text-sm":"h-8 text-xs"} pl-8 pr-3 rounded-lg border border-border/60 bg-white/70 dark:bg-black/20 text-primary placeholder:text-secondary/60 focus:outline-none focus:ring-2 focus:ring-accent/20`})]}),e.jsx("button",{type:"button",onClick:()=>ns(t=>!t),className:`h-8 px-2.5 rounded-lg border text-[10px] font-bold uppercase tracking-wider transition-colors ${dt?"bg-black/10 dark:bg-white/10 border-border text-primary":"bg-white/60 dark:bg-black/10 border-border/60 text-secondary hover:bg-black/5 dark:hover:bg-white/5"}`,children:dt?"Hide Archived":`Archived ${Xe.length}`})]}),e.jsxs("div",{className:"px-1 text-[10px] text-secondary/70 flex items-center justify-between",children:[e.jsx("span",{children:"Cmd/Ctrl+K to open search"}),e.jsx("span",{children:"Cmd+[ / Cmd+] to navigate"})]})]}),e.jsxs("div",{className:"pt-2 space-y-2",children:[!r&&e.jsx("div",{className:"px-2 py-3 text-xs text-secondary/70",children:"Sign in to store and restore sessions."}),r&&Je&&e.jsx("div",{className:"px-2 py-3 text-xs text-secondary/70",children:"Loadingâ€¦"}),r&&!Je&&ut.length===0&&e.jsx("div",{className:"px-2 py-3 text-xs text-secondary/70",children:"No saved sessions yet. Start a chat to persist it."}),r&&!Je&&ut.length>0&&yt.length===0&&e.jsx("div",{className:"px-2 py-3 text-xs text-secondary/70",children:"No sessions match your search."}),r&&!Je&&tr.map(t=>e.jsxs("div",{className:"space-y-1.5",children:[e.jsx("div",{className:"px-2 text-[10px] font-bold uppercase tracking-wider text-secondary/70",children:t.label}),t.items.map(s=>e.jsx("div",{className:`w-full px-1.5 py-1.5 rounded-lg border transition-all ${s.id===b?"bg-black/5 dark:bg-white/5 border-border":"border-transparent hover:bg-black/5 dark:hover:bg-white/5"}`,children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>gt(s.id),className:"min-w-0 flex-1 text-left",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("div",{className:"text-xs font-semibold text-primary truncate",children:s.title}),s.id===b&&e.jsx(ys,{size:12,className:"shrink-0 text-accent"})]}),e.jsx("div",{className:"mt-0.5 text-[11px] text-secondary/80 line-clamp-2",children:s.preview}),e.jsxs("div",{className:"mt-1.5 flex items-center gap-2 text-[10px] text-secondary/70",children:[e.jsx("span",{children:s.relativeAge}),e.jsx("span",{children:"â€¢"}),e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(Br,{size:11}),s.messageCount]})]})]}),e.jsx("button",{type:"button",onClick:l=>{l.stopPropagation(),er(s.id)},className:"shrink-0 p-1.5 rounded-md text-secondary hover:text-primary hover:bg-black/5 dark:hover:bg-white/5 transition-colors",title:s.archived?"Restore session":"Archive session","aria-label":s.archived?"Restore session":"Archive session",children:s.archived?e.jsx(Lr,{size:13}):e.jsx(Or,{size:13})})]})},s.id))]},t.label))]})]})]}),e.jsxs("button",{type:"button",onClick:()=>{Re(!Me),ce(!1),_e(!1)},title:`Profile: ${(k==null?void 0:k.name)||"Default"}`,"aria-label":"Select automation profile",className:`relative group flex items-center justify-center h-8 px-2 rounded-full transition-all gap-1 ${Me?"bg-black/10 dark:bg-white/10 text-primary":"text-secondary hover:bg-black/5 dark:hover:bg-white/5"}`,children:[e.jsx(Wt,{size:14}),e.jsx("span",{className:"max-w-[96px] truncate text-[11px] font-semibold",children:(k==null?void 0:k.name)||"Profile"}),e.jsx(Yt,{size:10,className:`text-secondary transition-transform ${Me?"rotate-180":""}`})]}),Me&&e.jsxs("div",{onMouseDown:t=>t.stopPropagation(),className:"pointer-events-auto absolute top-full mt-2 left-1/2 -translate-x-1/2 z-[220] w-[min(360px,calc(100vw-2rem))] bg-white/90 dark:bg-[#2C2C2E]/90 backdrop-blur-xl border border-border/50 rounded-xl shadow-spotlight overflow-hidden animate-fade-in p-2",children:[e.jsxs("div",{className:"flex items-center justify-between px-1 pb-2",children:[e.jsx("div",{className:"text-[10px] font-bold uppercase tracking-wider text-secondary",children:"Automation Profiles"}),is&&e.jsx("div",{className:"text-[10px] font-bold text-accent",children:is})]}),e.jsx("div",{className:"space-y-1",children:Te.map(t=>{const s=t.id===(k==null?void 0:k.id);return e.jsxs("button",{type:"button",onClick:()=>rr(t.id),className:`w-full text-left px-2 py-2 rounded-lg border transition-colors ${s?"bg-black/5 dark:bg-white/5 border-border text-primary":"border-transparent hover:bg-black/5 dark:hover:bg-white/5 text-secondary"}`,children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("span",{className:"text-xs font-semibold truncate",children:t.name}),s&&e.jsx(ys,{size:12,className:"text-accent shrink-0"})]}),e.jsxs("div",{className:"text-[10px] text-secondary/70 truncate",children:[t.gearMode," Â· ",t.modelId]})]},t.id)})}),e.jsxs("div",{className:"mt-2 pt-2 border-t border-border/50 flex items-center justify-between gap-2",children:[e.jsx("div",{className:"text-[10px] text-secondary/70",children:"Edit combos in Settings â†’ Profiles"}),e.jsxs("button",{type:"button",onClick:()=>{Re(!1),c()},className:"inline-flex items-center gap-1 px-2 py-1 rounded-md text-[10px] font-bold text-secondary hover:text-primary hover:bg-black/5 dark:hover:bg-white/5 transition-colors",children:[e.jsx(Wt,{size:12})," Manage"]})]})]}),e.jsxs("button",{type:"button",onClick:()=>{Re(!1),ce(!1),confirm("Clear entire session and context? This starts a new chat.")&&Ot()},title:"Clear Session","aria-label":"Clear session",className:"relative group flex items-center justify-center w-8 h-8 rounded-full transition-all text-secondary hover:bg-rose-500/10 hover:text-rose-600",children:[e.jsx(Kt,{size:14}),e.jsx("span",{className:"absolute bottom-full mb-2 left-1/2 -translate-x-1/2 px-2 py-1 bg-black/80 text-white text-[10px] rounded shadow-sm opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-50",children:"Clear Session"})]}),e.jsxs("button",{onClick:()=>{ce(!Ie),Re(!1),_e(!1)},className:`relative group flex items-center justify-center w-8 h-8 rounded-full transition-all ${Ie?"bg-black/10 dark:bg-white/10 text-primary":"text-secondary hover:bg-black/5 dark:hover:bg-white/5"}`,"aria-label":"More controls",title:"More controls",children:[e.jsx(Fr,{size:16}),e.jsx("span",{className:"absolute bottom-full mb-2 left-1/2 -translate-x-1/2 px-2 py-1 bg-black/80 text-white text-[10px] rounded shadow-sm opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-50",children:"More controls"})]}),Ie&&e.jsxs("div",{onMouseDown:t=>t.stopPropagation(),className:"pointer-events-auto absolute top-full mt-2 left-1/2 -translate-x-1/2 z-[220] w-[min(360px,calc(100vw-2rem))] bg-white/90 dark:bg-[#2C2C2E]/90 backdrop-blur-xl border border-border/50 rounded-xl shadow-spotlight overflow-hidden animate-fade-in p-2",children:[e.jsx("div",{className:"flex items-center justify-between px-1 pb-2",children:e.jsx("div",{className:"text-[10px] font-bold uppercase tracking-wider text-secondary",children:"Workspace Controls"})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"px-2 pb-1 text-[10px] font-bold uppercase tracking-wider text-secondary",children:"Active Profile"}),e.jsxs("div",{className:"mx-1 p-2 rounded-lg border border-border/50 bg-surface/60 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-xs font-semibold text-primary truncate",children:(k==null?void 0:k.name)||"Default"}),e.jsxs("div",{className:"text-[10px] text-secondary/80 truncate",children:[(k==null?void 0:k.gearMode)||"auto"," Â· ",(k==null?void 0:k.modelId)||n.defaultModelId]})]}),e.jsxs("button",{type:"button",onClick:()=>{ce(!1),c()},className:"inline-flex items-center gap-1 px-2 py-1 rounded-md text-[10px] font-bold text-secondary hover:text-primary hover:bg-black/5 dark:hover:bg-white/5 transition-colors",children:[e.jsx(Wt,{size:12}),"Manage"]})]}),e.jsx("div",{className:"text-[10px] text-secondary/70",children:"Mode switches moved to Settings â†’ Profiles."})]})]}),i.canUseBrowserAutomation&&se&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"px-2 pb-1 text-[10px] font-bold uppercase tracking-wider text-secondary",children:"Skill Memory"}),e.jsxs("div",{className:"mx-1 p-2 rounded-lg border border-border/50 bg-surface/60 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-[10px] text-secondary/80",children:[e.jsxs("span",{children:[Qe.total," learned"]}),pt&&e.jsx("span",{children:"Loading..."})]}),e.jsx("div",{className:"flex flex-wrap gap-1",children:ps.length>0?ps.map(([t,s])=>e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-white/60 dark:bg-black/20 border border-border/50 text-[10px] text-secondary",children:[e.jsx("span",{children:zs(t)}),e.jsx("span",{className:"font-semibold text-primary",children:s})]},`mobile-${t}`)):e.jsx("span",{className:"text-[10px] text-secondary/70",children:"No learned intents yet"})}),e.jsx("div",{className:"max-h-20 overflow-y-auto pr-1 space-y-1",children:Qe.recent.slice(0,3).map((t,s)=>e.jsxs("div",{className:"text-[10px] text-secondary/80",children:[e.jsx("div",{className:"font-semibold text-primary truncate",children:t.target||zs(t.intent)}),e.jsxs("div",{className:"truncate",children:[vn(t)," â€¢ ",Os(t.lastUsed)]})]},`mobile-recent-${t.intent}-${s}`))}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs("button",{type:"button",onClick:()=>{Ft()},disabled:pt||_t,className:"flex-1 flex items-center justify-center gap-1 px-2 py-1.5 rounded-md text-[10px] font-semibold border border-border/50 hover:bg-black/5 dark:hover:bg-white/5 transition-colors disabled:opacity-60",children:[pt?e.jsx(qe,{size:12,className:"animate-spin"}):e.jsx(ws,{size:12}),"Refresh"]}),e.jsxs("button",{type:"button",onClick:()=>{sr()},disabled:pt||_t||Qe.total===0,className:"flex-1 flex items-center justify-center gap-1 px-2 py-1.5 rounded-md text-[10px] font-semibold border border-rose-500/30 text-rose-600 hover:bg-rose-500/10 transition-colors disabled:opacity-50",children:[_t?e.jsx(qe,{size:12,className:"animate-spin"}):e.jsx(Kt,{size:12}),"Clear"]})]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"px-2 pb-1 text-[10px] font-bold uppercase tracking-wider text-secondary",children:"Peer Agents"}),e.jsx("div",{className:"max-h-36 overflow-y-auto pr-1 space-y-1",children:Sr.map(t=>e.jsxs("button",{type:"button",onClick:()=>{ce(!1),fs(t)},className:"w-full flex items-center justify-between px-2 py-2 rounded-lg hover:bg-black/5 dark:hover:bg-white/5 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx(t.icon,{size:14,className:t.color}),e.jsxs("div",{className:"flex flex-col items-start min-w-0",children:[e.jsx("span",{className:"text-xs font-semibold text-primary truncate",children:t.role}),e.jsx("span",{className:"text-[10px] text-secondary font-mono truncate",children:t.model})]})]}),e.jsx("span",{className:"text-[10px] font-bold text-primary/80 tracking-tighter uppercase",children:t.modelDisplay})]},t.id))})]}),e.jsx("div",{className:"mt-2 pt-2 border-t border-border/50 space-y-1",children:e.jsxs("button",{type:"button",onClick:()=>{ce(!1),confirm("Clear entire session and context? This starts a new chat.")&&Ot()},className:"w-full flex items-center justify-between px-2 py-2 rounded-lg hover:bg-black/5 dark:hover:bg-white/5 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Kt,{size:14,className:"text-rose-500"}),e.jsx("span",{className:"text-xs font-semibold text-primary",children:"Clear Session"})]}),e.jsx("span",{className:"text-[10px] text-secondary/70",children:"Reset"})]})}),e.jsxs("div",{className:"mt-2 pt-2 border-t border-border/50 space-y-1",children:[m.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{type:"button",onClick:()=>{ce(!1),or()},className:"w-full flex items-center justify-between px-2 py-2 rounded-lg hover:bg-black/5 dark:hover:bg-white/5 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Rr,{size:14,className:"text-accent"}),e.jsx("span",{className:"text-xs font-semibold text-primary",children:"Copy Chat"})]}),e.jsx("span",{className:"text-[10px] text-secondary/70",children:"Clipboard"})]}),e.jsxs("button",{type:"button",onClick:async()=>{ce(!1),R(!0),await Ss.autoOrganizeChat(m),R(!1)},disabled:U,className:"w-full flex items-center justify-between px-2 py-2 rounded-lg hover:bg-black/5 dark:hover:bg-white/5 transition-colors disabled:opacity-60",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[U?e.jsx(qe,{size:14,className:"animate-spin text-indigo-600"}):e.jsx(jt,{size:14,className:"text-indigo-600"}),e.jsx("span",{className:"text-xs font-semibold text-primary",children:"Sync to Knowledge"})]}),e.jsx("span",{className:"text-[10px] text-secondary/70",children:U?"Syncingâ€¦":"Run"})]})]}),i.canReloadExtension&&e.jsxs("button",{type:"button",onClick:()=>{ce(!1),X.restartExtension()},className:"w-full flex items-center justify-between px-2 py-2 rounded-lg hover:bg-black/5 dark:hover:bg-white/5 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ws,{size:14,className:"text-secondary"}),e.jsx("span",{className:"text-xs font-semibold text-primary",children:"Restart Extension"})]}),e.jsx("span",{className:"text-[10px] text-secondary/70",children:"Run"})]})]})]})]})})]}),e.jsxs("div",{ref:ke,className:`chat-scroll-container relative z-0 flex-1 overflow-y-auto p-3 sm:p-4 pt-3 ${se?"pb-[calc(8.25rem+var(--keyboard-inset)+env(safe-area-inset-bottom))] sm:pb-[calc(7.75rem+var(--keyboard-inset))]":"pb-[calc(10.75rem+var(--keyboard-inset)+env(safe-area-inset-bottom))] sm:pb-[calc(9.75rem+var(--keyboard-inset))]"} space-y-8 scrollbar-thin`,children:[m.map((t,s)=>e.jsx(on,{message:t,isStreaming:C&&s===m.length-1,agentStatus:s===m.length-1?B:"",onSetArtifact:nr},t.id)),e.jsx("div",{ref:Zs,className:"h-2"})]}),(ht.canUp||ht.canDown)&&e.jsxs("div",{className:"pointer-events-none absolute right-3 bottom-[calc(4.9rem+var(--keyboard-inset)+env(safe-area-inset-bottom))] sm:bottom-[calc(4.5rem+var(--keyboard-inset))] z-30 flex flex-col gap-2",children:[ht.canUp&&e.jsx("button",{type:"button",onClick:()=>{var t;fe.current=!1,(t=ke.current)==null||t.scrollTo({top:0,behavior:"smooth"})},className:"pointer-events-auto w-10 h-10 rounded-full bg-surface/80 dark:bg-[#1E1F20]/80 backdrop-blur-2xl border border-border/40 shadow-lg flex items-center justify-center text-secondary hover:text-primary hover:bg-white/50 dark:hover:bg-white/10 transition-colors",title:"Scroll to top","aria-label":"Scroll to top",children:e.jsx(js,{className:"w-4 h-4"})}),ht.canDown&&e.jsx("button",{type:"button",onClick:()=>{fe.current=!0,tt("smooth")},className:"pointer-events-auto w-10 h-10 rounded-full bg-surface/80 dark:bg-[#1E1F20]/80 backdrop-blur-2xl border border-border/40 shadow-lg flex items-center justify-center text-secondary hover:text-primary hover:bg-white/50 dark:hover:bg-white/10 transition-colors",title:"Scroll to bottom","aria-label":"Scroll to bottom",children:e.jsx(Er,{className:"w-4 h-4"})})]}),Js&&e.jsx("div",{className:"absolute bottom-[calc(8.5rem+var(--keyboard-inset))] sm:bottom-[calc(7rem+var(--keyboard-inset))] left-1/2 -translate-x-1/2 z-50 animate-slide-in",children:e.jsxs("div",{className:"bg-indigo-600 text-white px-4 py-2 rounded-full shadow-2xl flex items-center gap-2 text-xs font-bold ring-4 ring-indigo-500/20",children:[e.jsx(jt,{size:14})," Findings Synchronized to Knowledge Base"]})}),Ze&&e.jsx("div",{className:"absolute bottom-[calc(6.25rem+var(--keyboard-inset))] sm:bottom-[calc(5.75rem+var(--keyboard-inset))] left-1/2 -translate-x-1/2 z-50 animate-slide-in",children:e.jsx("div",{className:`px-4 py-2 rounded-full shadow-2xl flex items-center gap-2 text-xs font-semibold ring-2 ${Ze.tone==="error"?"bg-rose-600 text-white ring-rose-500/25":"bg-primary text-white ring-primary/20"}`,children:Ze.text})}),e.jsxs("div",{className:`${se?"absolute":"fixed"} bilge-chat-composer bottom-0 inset-x-0 mx-auto w-full max-w-3xl px-2 sm:px-5 z-[140] pb-[calc(0.45rem+env(safe-area-inset-bottom)+var(--keyboard-inset))] sm:pb-[calc(0.85rem+var(--keyboard-inset))] transition-all duration-700 ease-in-out ${Nt?"top-[58%] -translate-y-1/2 bottom-auto":""}`,children:[ms.length>0&&m.length>0&&!se&&e.jsxs("div",{className:"mb-2 px-2 flex items-center gap-1.5 flex-wrap",children:[e.jsx("span",{className:"text-[10px] font-bold uppercase tracking-wider text-secondary/70",children:"Recent"}),ms.map(t=>e.jsxs("button",{type:"button",onClick:()=>gt(t.id),className:"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full border border-border/50 bg-surface/70 dark:bg-white/5 text-[10px] font-medium text-secondary hover:text-primary hover:bg-black/5 dark:hover:bg-white/10 transition-colors max-w-[220px]",title:t.title,children:[e.jsx("span",{className:"truncate",children:t.title}),e.jsx("span",{className:"text-secondary/60",children:t.relativeAge})]},t.id))]}),e.jsxs("form",{onSubmit:Ut,className:"relative group",children:[F.length>0&&e.jsxs("div",{className:"mb-3 px-2 animate-fade-in",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("button",{type:"button",onClick:()=>Z(t=>!t),className:"flex items-center gap-2 px-3 py-1 rounded-full bg-surface/60 dark:bg-white/5 border border-border/50 text-[10px] font-mono text-secondary backdrop-blur-md shadow-sm hover:text-primary transition-colors",title:be?"Hide context files":"Show context files","aria-label":be?"Hide context files":"Show context files",children:[e.jsx(Gs,{size:12,className:"opacity-70"}),e.jsx("span",{className:"font-bold",children:"Context"}),e.jsx("span",{className:"font-bold text-primary",children:F.length}),e.jsx(Yt,{size:12,className:`opacity-70 transition-transform ${be?"rotate-180":""}`})]}),e.jsx("button",{type:"button",onClick:()=>{J([]),de("Context Cleared")},className:"px-2.5 py-1 rounded-full bg-rose-500/10 border border-rose-500/20 text-[10px] font-bold text-rose-600 hover:bg-rose-500 hover:text-white transition-all backdrop-blur-md",title:"Clear context","aria-label":"Clear context",children:"Clear"})]}),be&&e.jsx("div",{className:"mt-2 max-h-[120px] overflow-y-auto pr-1 scrollbar-thin",children:e.jsxs("div",{className:"flex flex-wrap gap-2",children:[F.slice(0,200).map(t=>e.jsxs("div",{className:"flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-surface/60 dark:bg-white/5 border border-border/50 text-[10px] font-mono text-secondary backdrop-blur-md shadow-sm group/chip",children:[e.jsx("span",{className:"truncate max-w-[120px]",title:t,children:t.split("/").pop()}),e.jsx("button",{type:"button",onClick:()=>J(s=>s.filter(l=>l!==t)),className:"hover:text-rose-500 transition-colors opacity-40 group-hover/chip:opacity-100",title:`Remove ${t}`,"aria-label":`Remove ${t}`,children:e.jsx(kt,{size:10})})]},t)),F.length>200&&e.jsxs("div",{className:"flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-surface/40 dark:bg-white/5 border border-border/50 text-[10px] font-mono text-secondary/70 backdrop-blur-md shadow-sm",children:["+",F.length-200," more"]})]})})]}),e.jsxs("div",{className:"bg-surface/85 dark:bg-[#1E1F20]/85 backdrop-blur-2xl rounded-[20px] sm:rounded-[22px] p-1.5 sm:p-2 flex flex-col gap-1.5 border border-border/50 shadow-spotlight focus-within:ring-2 focus-within:ring-accent/20 transition-all",children:[es&&e.jsxs("div",{className:"px-4 pt-2 relative",children:[e.jsx("img",{src:es,className:"h-20 rounded-xl border border-border/50 shadow-sm"}),e.jsx("button",{type:"button",onClick:()=>Ce(null),title:"Remove image","aria-label":"Remove image",className:"absolute top-0 right-0 p-1 bg-white dark:bg-black rounded-full shadow-md border border-border/50",children:e.jsx(kt,{size:14})})]}),e.jsxs("div",{className:"flex items-center gap-2 w-full",children:[e.jsx("button",{type:"button",onClick:()=>{var t;return(t=ts.current)==null?void 0:t.click()},title:"Attach image","aria-label":"Attach image",className:"p-2 hover:bg-black/5 dark:hover:bg-white/5 rounded-full ml-0.5 transition-colors",children:e.jsx(Ur,{className:"w-[18px] h-[18px] text-secondary"})}),e.jsx("input",{type:"file",ref:ts,className:"hidden",accept:"image/*",onChange:t=>{var s;(s=t.target.files)!=null&&s[0]&&($e(t.target.files[0]),Ce(URL.createObjectURL(t.target.files[0])))}}),e.jsx("button",{type:"button",onClick:()=>{var t;return(t=ss.current)==null?void 0:t.click()},title:"Load folder context","aria-label":"Load folder context",className:"p-2 hover:bg-black/5 dark:hover:bg-white/5 rounded-full transition-colors",children:e.jsx(Es,{className:"w-[18px] h-[18px] text-secondary"})}),e.jsx("input",{type:"file",ref:ss,className:"hidden",webkitdirectory:"",directory:"",multiple:!0,onChange:ar}),e.jsx(an,{ref:Ge,value:G,onChange:t=>{O(t),Ge.current&&zt(Ge.current)},onExecute:t=>{O(t),setTimeout(()=>Ut(),10)},onKeyDown:t=>{var s;t.key==="Enter"&&!t.shiftKey&&(t.preventDefault(),(s=t.currentTarget.closest("form"))==null||s.requestSubmit())},pageFields:he,isTextarea:!0,placeholder:ye?"Full Power: patch, browse, or automate...":"Ask me anything...",disabled:C,className:"flex-1 bg-transparent border-none py-2 px-1 text-[15px] focus:ring-0 text-primary placeholder:text-secondary/50 resize-none min-h-[44px] max-h-[180px] leading-5"}),e.jsx("button",{type:C?"button":"submit",onClick:C?Pe:void 0,disabled:C?!1:!G.trim()&&!ct,title:C?"Stop (Esc)":"Send","aria-label":C?"Stop generation":"Send message",className:`p-2 rounded-full transition-all ${C?"bg-rose-600 text-white shadow-lg hover:bg-rose-700":G.trim()||ct?"bg-accent text-white shadow-lg":"bg-secondary/10 text-secondary"}`,children:C?e.jsx(jr,{className:"w-4 h-4"}):e.jsx(js,{className:"w-4 h-4"})})]})]})]})]})]}),E!=="none"&&e.jsx("div",{className:"fixed inset-x-0 bottom-0 top-[var(--app-header-offset)] z-40 bg-surface md:static md:inset-auto md:z-40 md:w-1/2 md:h-full md:border-l md:border-border md:shadow-2xl",children:E==="artifact"&&W&&e.jsx(Mr,{isVisible:!0,content:W.content,language:W.language,onClose:()=>L("none")})})]})};export{Dn as HomePage};
